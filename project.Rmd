---
title: "*Drosophila* Time Series - Project Evaluation Sheet"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float: true
    keep_md: FALSE
---
<style type="text/css">
  body .main-container {
    max-width: 1800px !important;
  }
  h1.title {
  font-size: 38px;
  color: DarkRed;
  text-align: center;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, packages, eval=FALSE, echo=FALSE}
## source the script with the functions needed for analysis
source("readXMLdatafile.R")
source("DTS_plotfunctions.R")
```

<center><h2>for time series data set: "<b>`r paste(project.data$experiment$title)`</b>"</h2></center>
<center>Rendered on `r format(Sys.time(), '%d %B %Y')`</center>

# Metadata

**Project file (YAML):** `r paste('<a href="', basename(project.file), '">', project.data$experiment$title, '</a>', sep = "")`  
**Description:** `r paste(project.data$experiment$description)`  
**Measurement RRID:** `r paste('<a href="https://scicrunch.org/resolver/RRID:', project.data$experiment$id, '">', project.data$experiment$id, '</a>', sep = "")`  
**Experimenter:** `r paste(experimenter$firstname, experimenter$lastname, sep = " ")`; **ORCID:** [`r paste(experimenter$orcid)`](http://orcid.org/`r paste(experimenter$orcid)`)  
**Experiment duration:** `r paste(seconds_to_period(as.numeric(as.character(experiment$duration))))`  

# Experimental Design
```{r expdesign, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = (round(NofPeriods/3)), fig.width = NofPeriods+1}
#Write table of period design
periods <- periods[-6,]
periods[3,periods["outcome",]==0]="test"
periods[3,periods["outcome",]==1]="training"
reactable(setDT(as.data.frame(periods), keep.rownames = "property")[],
  striped = TRUE,
  highlight = TRUE,
  bordered = TRUE,
  resizable = TRUE,
  compact = TRUE,
  columns = list(property = colDef(style = list(position = "sticky", left = 0, background = "#fff", zIndex = 1),
    headerStyle = list(position = "sticky", left = 0, background = "#fff", zIndex = 1))))
```

```{r Graphdim, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
len = as.integer(lengths(project.data["resources"])*5)
aspect_ratio = 4/nrow(sequence %>% na.omit())
```

# Experimental groups and single fly evaluations

**Number of experimental groups:** `r paste(NofGroups)`
```{r singleflydata, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
exp_groups <- sapply(exp_groups, '[', seq(max(lengths(exp_groups)))) #make dataframe from list
colnames(exp_groups) = as.character(exp_groups[1, ]) # make group names to column names
if(!is.null(groupids)){exp_groups[1, ] <- groupids}else{exp_groups <- exp_groups[-1, ]} 
rownames(exp_groups) <- NULL #remove the numbers
#plot table with links to individual fly evaluations
reactable(exp_groups,
  striped = TRUE,
  highlight = TRUE,
  bordered = TRUE,
  resizable = TRUE,
  compact = TRUE,
  fullWidth = FALSE,
  defaultColDef = colDef(html = TRUE), 
  defaultPageSize = 45)
```

# Histograms
## Fly Behavior Histograms

```{r FlyHistogram, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

for(x in 1:NofGroups)
  {
    cat("<center><h4>",project.data[["resources"]][[x]][["title"]],"</h4></center>")
    flyhistos <- grouped.flyhistos[[x]]
    grid.arrange(grobs = flyhistos, ncol=round(NofPeriods/5)) #flyhistos
}  
```


```{r PositionHistogram, eval=('fs' %in% sequence$type || 'color' %in% sequence$type), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    
cat("\n## Arena Position Histograms\n")
for(x in 1:NofGroups)
  {
    cat("<center><h4>",project.data[["resources"]][[x]][["title"]],"</h4></center>")
    poshistos <- grouped.poshistos[[x]]
    grid.arrange(grobs = Filter(Negate(is.null), poshistos), ncol=round(sum(poshistos!="NULL")/5)) #positionhistos
}

```

<!-- Superimposed histograms -->

```{r SupPosHistograms, eval=(NofGroups==2), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}    

if('yt' %in% sequence$type || 'sw' %in% sequence$type)                  #for yt or sw experiments, plot fly data
      {
       cat("\n## Superimposed Histograms\n")
       print(ggplot(supHistos, aes(x = fly)) + 
            geom_rect(aes(xmin = -Inf, xmax = 0, ymin = -Inf, ymax = Inf), fill=("lightgrey")) +
            geom_histogram(aes(fill = group, y=..density..), position = "identity", alpha=0.4, binwidth=3) +
            labs(x="Fly Behavior [arb. units]", y="rel. frequency") + 
            scale_x_continuous(limits=maxfly, breaks = c(-200, -100, 0, 100, 200), expand = c(0,0)) +
            scale_y_continuous(expand = c(0,0)) +
            ggtitle("Superimposed Fly Behavior Histogram") +
            scale_fill_manual(values = c("#E7B800", "#00AFBB")) +
            theme_light() +
            theme(panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank()) +
            annotate("text", -Inf, Inf, label = "punished torque domain", hjust = -0.2, vjust = 1.3)+
            annotate("text", Inf, Inf, label = "unpunished torque domain", hjust =1.1, vjust = 1.3))
  
      } else if ('fs' %in% sequence$type || 'color' %in% sequence$type) #for fs or color experiments, plot folded arena position data
      {
       cat("\n## Superimposed Histograms\n")
       print(ggplot(supHistos, aes(x = a_pos)) + 
            geom_rect(aes(xmin = -Inf, xmax = 45, ymin = -Inf, ymax = Inf), fill=("lightgrey")) +
            geom_histogram(aes(fill = group, y=..density..), position = "identity", alpha=0.4, binwidth=1) +
            labs(x="Arena Position [degrees]", y="rel. frequency") + 
            scale_x_continuous(breaks = c(0, 45, 90), expand = c(0,0)) +
            scale_y_continuous(expand = c(0,0)) +
            ggtitle("Superimposed Position Histogram") +
            scale_fill_manual(values = c("#E7B800", "#00AFBB")) +
            theme_light() +
            theme(panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank()) +
            annotate("text", -Inf, Inf, label = "'hot' hemi-quadrant", hjust = -0.6, vjust = 1.3)+
            annotate("text", Inf, Inf, label = "'cold' hemi-quadrant", hjust =1.5, vjust = 1.3))
      }
```

<!-- Computing optomotor data if they are present -->

`r if (om | beforeafter) '# Optomotor evaluations'`
`r if (om) '## Optomotor traces (right/left)'`

```{r Optomotor, eval=om, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 10, comment=NA, results='asis'}

plotOMtracesMean(grouped.OMdata) #call function to plot OM traces averaged over all flies
```

`r if (beforeafter) '## Optomotor traces (right/left) at start of experiment'`

```{r OM_BeforeAfter, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 10, comment=NA, results='asis'}

plotOMtracesMean(grouped.OMdataBefore) #call function to plot OM traces at start of experiment averaged over all flies
  
cat(paste("\n\n## Optomotor traces (right/left) at end of experiment\n\n"))

plotOMtracesMean(grouped.OMdataAfter) #call function to plot OM traces at end of experiment averaged over all flies
```

`r if (om | beforeafter) '## Optomotor Parameter Analysis'`

```{r OMparams, eval=om, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}

####### Do not separate optomotor parameters at all ##########


plotOMparams=ldply(grouped.OMparams, data.frame)    #move the dataframes from each group into a single dataframe
OMvariables = head(names(plotOMparams),-1)
OMtitles = c("Optomotor Magnitude", "Rate Constant", "Asymmetry Index")

#for one group without statistics
if(NofGroups==1)
  {
        for (v in 1:3) {
           cat(paste("\n\n## ", OMtitles[v], "\n\n", sep = ""))
           print(ggplot(plotOMparams, aes(group, plotOMparams[[OMvariables[v]]])) +
              geom_boxplot(fill = boxcolors, notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = plotOMparams, aes(group, plotOMparams[[OMvariables[v]]]), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
              theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
              samplesizes.annotate(boxes, samplesizes))
        }
}

#for two groups with statistics
if(NofGroups==2)
  {
        for (v in 1:3) {
           cat(paste("\n\n## ", OMtitles[v], "\n\n", sep = ""))
            utest = signif(wilcox.test(plotOMparams[[OMvariables[v]]] ~ plotOMparams$group)$p.value, 3) #compare the two groups with a U-test and collect p-value
            w.statistic = signif(wilcox.test(plotOMparams[[OMvariables[v]]] ~ plotOMparams$group)$statistic, 3)
            #compute effect size Cohen's D
            cohend = signif(cohen.d(plotOMparams[[OMvariables[v]]] ~ plotOMparams$group)$estimate, 3)
            #calculate statistical power
            alt = project.data[["statistics"]][["two.groups"]][["power"]]
            power=signif(pwr.t2n.test(n1 = samplesizes[1], n2= samplesizes[2], d = cohend, alternative = alt, sig.level = signif[1])$power, 3)
            #calculate Bayes Factor
            bayesF=extractBF(ttestBF(plotOMparams[[OMvariables[v]]][plotOMparams$group==groupnames[1]], plotOMparams[[OMvariables[v]]][plotOMparams$group==groupnames[2]]))
            #calculate FPR for priors set in project file#
            #run first prior  
              prior=priorval[1]
              out=calc.FPR(samplesizes,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
              fpz1=out[1]
            #run second prior  
              prior=priorval[2]
              out=calc.FPR(samplesizes,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
              fpz2=out[1]
            #Power and likelihood ratio: NB for two sided test, need 2*y0
              LR=out[5]/(2*out[3])        #lik ratio (Hi1/H0) =y1/2*y0
        
              #make tidy table of results
            results.utest<-data.frame(values=c(signif[1],
                                               w.statistic,
                                               cohend,
                                               power,
                                               signif(bayesF$bf, 3),
                                               signif(bayesF$error, 3),
                                               signif(fpz1, 3),
                                               signif(fpz2, 3),
                                               signif(LR, 3)))
            rownames(results.utest)<-c("Significance level",
                                       "MW U-Test, W",
                                       "Cohen's D",
                                       "stat. Power",
                                       "Bayes Factor",
                                       "Bayes Factor error",
                                       paste("FP risk, prior ",priorval[1]),
                                       paste("FP risk, prior ",priorval[2]),
                                       "Likelihood Ratio")
            
        # plot two PIs with asterisks
          plots.2test<-list(ggplot(plotOMparams, aes(group, plotOMparams[[OMvariables[v]]])) +
              geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = plotOMparams, aes(group, plotOMparams[[OMvariables[v]]]), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
              ggtitle(paste("U-Test, p=", utest)) +
              theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
              geom_signif(comparisons = list(c(groupnames)), map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]), textsize=8, vjust=0.5) +
              samplesizes.annotate(boxes, samplesizes))
        
          #add table with results and plot
          plots.2test[[2]]<-tableGrob(results.utest)
          grid.arrange(grobs = plots.2test, ncol=2)
        } #for 
}



```

```{r OMparamsBefore, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}

######### Separate optomotor evaluations: optomotor parameters at the start of the experiment ###############

plotOMparamsBefore=ldply(grouped.OMparamsBefore, data.frame)    #move the dataframes from each group into a single dataframe
OMvariables = head(names(plotOMparamsBefore),-1)
OMtitles = c("Optomotor Magnitude", "Rate Constant", "Asymmetry Index")

#for one group without statistics
if(NofGroups==1)
  {
        for (v in 1:3) {
           cat(paste("\n\n## ", OMtitles[v], " at start of experiment\n\n", sep = ""))
           print(ggplot(plotOMparamsBefore, aes(group, plotOMparamsBefore[[OMvariables[v]]])) +
              geom_boxplot(fill = boxcolors, notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = plotOMparamsBefore, aes(group, plotOMparamsBefore[[OMvariables[v]]]), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
              theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
              samplesizes.annotate(boxes, samplesizes))
        }
}

#for two groups with statistics
if(NofGroups==2)
  {
        for (v in 1:3) {
          cat(paste("\n\n## ", OMtitles[v], " at start of experiment\n\n", sep = ""))
            plots.2test<-plotOMParamBox(v, plotOMparamsBefore, samplesizes, OMvariables, OMtitles) #call function to plot box/whisker diagram and calculate statistics
          grid.arrange(grobs = plots.2test, ncol=2)
        }
}

#for three groups with statistics

if(NofGroups==3)
{
  Count=1
  Control=list()
  Exp=list()
  for (t in 1:NofGroups) {
    if(grepl("test", tolower(grouped.OMparamsBefore[[t]]$desc)) | grepl("exp", tolower(grouped.OMparamsBefore[[t]]$desc)) | grepl("experimental", tolower(grouped.OMparamsBefore[[t]]$desc))==TRUE){
      Exp = na.omit(grouped.OMparamsBefore[[t]])
    } else {
      Control[[Count]] =na.omit(grouped.OMparamsBefore[[t]])
      Count=Count+1
    }
  }
  PIname<-c(unique(Exp$group), unique(Control[[1]]$group),unique(Control[[2]]$group))
  for (v in 1:3) {
    cat(paste("\n\n## ", OMtitles[v], " at start of experiment\n\n", sep = ""))
    utest1 = signif(wilcox.test(Exp[[v]],Control[[1]][[v]])$p.value, 3)
    utest2 = signif(wilcox.test(Exp[[v]],Control[[2]][[v]])$p.value, 3)#compare the two groups with a U-test and collect p-value
    w.statistic1 = signif(wilcox.test(Exp[[v]],Control[[1]][[v]])$statistic, 3)
    w.statistic2 = signif(wilcox.test(Exp[[v]],Control[[2]][[v]])$statistic, 3)
    #compute effect size Cohen's D
    cohend1 = signif(cohen.d(Exp[[v]], Control[[1]][[v]])$estimate, 3)
    cohend2 = signif(cohen.d(Exp[[v]], Control[[2]][[v]])$estimate, 3)
    #calculate statistical power
    alt = project.data[["statistics"]][["three.groups"]][["power"]]
    power1=signif(pwr.t2n.test(n1 = length(Exp), n2= length(Control[[1]]), d = cohend1, alternative = alt, 
                               sig.level = signif[1])$power, 3)
    power2=signif(pwr.t2n.test(n1 = length(Exp), n2= length(Control[[2]]), d = cohend2, alternative = alt, 
                               sig.level = signif[1])$power, 3)
    #calculate Bayes Factor
    bayesF1=extractBF(ttestBF(Exp[[v]], Control[[1]][[v]]))
    bayesF2=extractBF(ttestBF(Exp[[v]], Control[[2]][[v]]))
    #calculate FPR for priors set in project file#
    #run first prior  
    prior=priorval[1]
    out1=calc.FPR(samplesizes,utest1,prior,abs(cohend1))  #output=c(FPR,x0,y0,x1,y1)
    fpz1=out1[1]
    #run second prior  
    prior=priorval[2]
    out1=calc.FPR(samplesizes,utest1,prior,abs(cohend1))  #output=c(FPR,x0,y0,x1,y1)
    fpz2=out1[1]
    #run first prior  
    prior=priorval[1]
    out2=calc.FPR(samplesizes,utest2,prior,abs(cohend2))  #output=c(FPR,x0,y0,x1,y1)
    fpz3=out2[1]
    #run second prior
    prior=priorval[2]
    out2=calc.FPR(samplesizes,utest2,prior,abs(cohend2))  #output=c(FPR,x0,y0,x1,y1)
    fpz4=out2[1]
    #Power and likelihood ratio: NB for two sided test, need 2*y0
    LR1=out1[5]/(2*out1[3])        #lik ratio (Hi1/H0) =y1/2*y0
    LR2=out2[5]/(2*out2[3])
    #make tidy table of results
    results.utest<-data.frame(cbind(TestxCont1=c(signif[1],
                                                 w.statistic1,
                                                 utest1,
                                                 cohend1,
                                                 power1,
                                                 signif(bayesF1$bf, 3),
                                                 signif(bayesF1$error, 3),
                                                 signif(fpz1, 3),
                                                 signif(fpz2, 3),
                                                 signif(LR1, 3)),
                                    TestxCont2=c(signif[1],
                                                 w.statistic2,
                                                 utest2,
                                                 cohend2,
                                                 power2,
                                                 signif(bayesF2$bf, 3),
                                                 signif(bayesF2$error, 3),
                                                 signif(fpz3, 3),
                                                 signif(fpz4, 3),
                                                 signif(LR2, 3))))
    colnames(results.utest)<-c(paste(PIname[1], PIname[2]),paste(PIname[1], PIname[3]))  
    
    
    
    rownames(results.utest)<-c("Significance level",
                               "MW U-Test, W",
                               "U-Test p-value", 
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")
    
    # plot two PIs with asterisks
    plots.2test<-ggplot(PIstatCombined, aes(group, PIs)) +
      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
      geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
      geom_jitter(data=PIstatCombined, aes(group, PIs, fill=category), 
                  position=position_jitter(0.3), shape=21, size=3) +
      scale_y_continuous(breaks = seq(-1, 1, .2)) +
      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                                          panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black",
                                                                      fill=NA), legend.position = "top", 
                                          legend.title = element_blank()) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+ 
      ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
      geom_signif(comparisons = list(c(colnames(PIstat[2]), colnames(PIstat[3]))), 
                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                  textsize=5, vjust=0.1) +
      geom_signif(comparisons = list(c(colnames(PIstat[1]), colnames(PIstat[3]))), 
                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                  textsize=5, vjust=0.1, y_position =1.2) +
      ylim(c(-1, 1.3)) +
      samplesizes.annotate(boxes, samplesizes)
    
    #add table with results and plot
    plots.2utest<-tableGrob(results.utest)
    
    grid.arrange(plots.2test,plots.2utest, nrow = 1)
    
  }
}
```

```{r OMparamsAfter, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}

######### Separate optomotor evaluations: optomotor parameters at the end of the experiment ###############

plotOMparamsAfter=ldply(grouped.OMparamsAfter, data.frame)    #move the dataframes from each group into a single dataframe
OMvariables = head(names(plotOMparamsAfter),-1)
OMtitles = c("Optomotor Magnitude", "Rate Constant", "Asymmetry Index")

#for one group without statistics
if(NofGroups==1)
  {
        for (v in 1:3) {
           cat(paste("\n\n## ", OMtitles[v], " at end of experiment\n\n", sep = ""))
           print(ggplot(plotOMparamsAfter, aes(group, plotOMparamsAfter[[OMvariables[v]]])) +
              geom_boxplot(fill = boxcolors, notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = plotOMparamsAfter, aes(group, plotOMparamsAfter[[OMvariables[v]]]), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
              theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
              samplesizes.annotate(boxes, samplesizes))
        }
}

#for two groups with statistics
if(NofGroups==2)
  {
        for (v in 1:3) {
           cat(paste("\n\n## ", OMtitles[v], " at end of experiment\n\n", sep = ""))
            plots.2test<-plotOMParamBox(v, plotOMparamsAfter, samplesizes, OMvariables, OMtitles) #call function to plot box/whisker diagram and calculate statistics
          grid.arrange(grobs = plots.2test, ncol=2)
        } 
}

#for three groups with statistics
if(NofGroups==3){
  Count=1
  Control=list()
  Exp=list()
  for (t in 1:NofGroups) {
    if(grepl("test", tolower(grouped.OMparamsAfter[[t]]$desc)) | grepl("exp", tolower(grouped.OMparamsAfter[[t]]$desc)) |      grepl("experimental", tolower(grouped.OMparamsAfter[[t]]$desc))==TRUE){
      Exp = na.omit(grouped.OMparamsAfter[[t]])
    } else {
      Control[[Count]] =na.omit(grouped.OMparamsAfter[[t]])
      Count=Count+1
    }
  }
  PIname<-c(unique(Exp$group), unique(Control[[1]]$group),unique(Control[[2]]$group))
  for (v in 1:3) {
    cat(paste("\n\n## ", OMtitles[v], " at end of experiment\n\n", sep = ""))
    utest1 = signif(wilcox.test(Exp[[v]],Control[[1]][[v]])$p.value, 3)
    utest2 = signif(wilcox.test(Exp[[v]],Control[[2]][[v]])$p.value, 3)#compare the two groups with a U-test and collect p-value
    w.statistic1 = signif(wilcox.test(Exp[[v]],Control[[1]][[v]])$statistic, 3)
    w.statistic2 = signif(wilcox.test(Exp[[v]],Control[[2]][[v]])$statistic, 3)
    #compute effect size Cohen's D
    cohend1 = signif(cohen.d(Exp[[v]], Control[[1]][[v]])$estimate, 3)
    cohend2 = signif(cohen.d(Exp[[v]], Control[[2]][[v]])$estimate, 3)
    #calculate statistical power
    alt = project.data[["statistics"]][["three.groups"]][["power"]]
    power1=signif(pwr.t2n.test(n1 = length(Exp), n2= length(Control[[1]]), d = cohend1, alternative = alt, 
                               sig.level = signif[1])$power, 3)
    power2=signif(pwr.t2n.test(n1 = length(Exp), n2= length(Control[[2]]), d = cohend2, alternative = alt, 
                               sig.level = signif[1])$power, 3)
    #calculate Bayes Factor
    bayesF1=extractBF(ttestBF(Exp[[v]], Control[[1]][[v]]))
    bayesF2=extractBF(ttestBF(Exp[[v]], Control[[2]][[v]]))
    #calculate FPR for priors set in project file#
    #run first prior  
    prior=priorval[1]
    out1=calc.FPR(samplesizes,utest1,prior,abs(cohend1))  #output=c(FPR,x0,y0,x1,y1)
    fpz1=out1[1]
    #run second prior  
    prior=priorval[2]
    out1=calc.FPR(samplesizes,utest1,prior,abs(cohend1))  #output=c(FPR,x0,y0,x1,y1)
    fpz2=out1[1]
    #run first prior  
    prior=priorval[1]
    out2=calc.FPR(samplesizes,utest2,prior,abs(cohend2))  #output=c(FPR,x0,y0,x1,y1)
    fpz3=out2[1]
    #run second prior
    prior=priorval[2]
    out2=calc.FPR(samplesizes,utest2,prior,abs(cohend2))  #output=c(FPR,x0,y0,x1,y1)
    fpz4=out2[1]
    #Power and likelihood ratio: NB for two sided test, need 2*y0
    LR1=out1[5]/(2*out1[3])        #lik ratio (Hi1/H0) =y1/2*y0
    LR2=out2[5]/(2*out2[3])
    #make tidy table of results
    results.utest<-data.frame(cbind(TestxCont1=c(signif[1],
                                                 w.statistic1,
                                                 utest1,
                                                 cohend1,
                                                 power1,
                                                 signif(bayesF1$bf, 3),
                                                 signif(bayesF1$error, 3),
                                                 signif(fpz1, 3),
                                                 signif(fpz2, 3),
                                                 signif(LR1, 3)),
                                    TestxCont2=c(signif[1],
                                                 w.statistic2,
                                                 utest2,
                                                 cohend2,
                                                 power2,
                                                 signif(bayesF2$bf, 3),
                                                 signif(bayesF2$error, 3),
                                                 signif(fpz3, 3),
                                                 signif(fpz4, 3),
                                                 signif(LR2, 3))))
    
    colnames(results.utest) <-c(paste(PIname[1], PIname[2]),paste(PIname[1], PIname[3]))  
    
    
    
    rownames(results.utest)<-c("Significance level",
                               "MW U-Test, W",
                               "U-Test p-value", 
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")
    
    # plot two PIs with asterisks
    plots.2test<-ggplot(PIstatCombined, aes(group, PIs)) +
      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
      geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
      geom_jitter(data=PIstatCombined, aes(group, PIs, fill=category), 
                  position=position_jitter(0.3), shape=21, size=3) +
      scale_y_continuous(breaks = seq(-1, 1, .2)) +
      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                                          panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black",
                                                                      fill=NA), legend.position = "top", 
                                          legend.title = element_blank()) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+ 
      ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
      geom_signif(comparisons = list(c(colnames(PIstat[2]), colnames(PIstat[3]))), 
                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                  textsize=5, vjust=0.1) +
      geom_signif(comparisons = list(c(colnames(PIstat[1]), colnames(PIstat[3]))), 
                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                  textsize=5, vjust=0.1, y_position =1.2) +
      ylim(c(-1, 1.3)) +
      samplesizes.annotate(boxes, samplesizes)
    
    #add table with results and plot
    plots.2utest<-tableGrob(results.utest)
    
    grid.arrange(plots.2test,plots.2utest, nrow = 1)
    
  }
}
```

# Fourier Spectrum Analysis

```{r spectra, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8}
spectemp <- do.call("rbind", grouped.spectra) #create single data.frame with grouping variable from list of groups
print(ggplot(spectemp, aes(x=freq, y=mean, group = group)) + 
        geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd, fill = group), alpha=0.5) +
        scale_fill_manual(values = boxcolors) +
        geom_line(aes(colour = group), size = 2) + 
        scale_color_manual(values = boxcolors) +
        scale_x_continuous(breaks = seq(0, 10, 2), limits = c(0, 10), expand=c(0,0)) +
        scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1), expand=c(0,0)) +
        ggtitle("Powerspectra") +
        guides(colour = guide_legend(override.aes = list(size=3))) +
        theme_light(base_size = 16) + theme(legend.justification=c(1,0),
                                            legend.position=c(0.94,0.60), 
                                            legend.title=element_blank(), 
                                            legend.key.size = unit(2, 'lines'),
                                            legend.key = element_rect(size = 6),
                                            legend.box.background = element_rect(fill="white"),
                                            legend.box.margin = margin(4, 4, 4, 4),
                                            legend.text=element_text(size=14), 
                                            panel.grid.major.y = element_blank(),
                                            panel.grid.minor = element_blank(),
                                            panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
        theme(axis.text.y = element_text(size=12))+ ylab("mean rel. Power") + xlab("Frequency [Hz]"))
```

<!-- Compute dwelling times -->

```{r Mean dwelling, eval=Dwell, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 8, comment=NA, results='asis'}

cat("\n# Dwelling Times\n")

dwellmeanplots = list() #create a list to store all the plots

for(x in 1:NofGroups){
  grouped.dwell[[x]]$punished = -grouped.dwell[[x]]$punished #invert the punished values to make the bars go downwards
  dwellmeans[[x]] = reshape2::melt(grouped.dwell[[x]])       #load each group of data into a dataframe
  colnames(dwellmeans[[x]])=c("period","value","Outcome")
  dwellmeanplots[[x]] <-   ggplot(dwellmeans[[x]], aes(as.factor(period), value, fill = Outcome)) +
  stat_summary(geom = "bar", fun = mean, col="black", width = 0.7)+
   stat_summary(geom = "errorbar", fun.data = mean_se, width = 0.3)+
  geom_hline(yintercept = 0, colour = "#887000", size = 1.2)+
  geom_jitter(pch=21, colour="Black", size=2.3, width = 0.25)+
  ggtitle(paste(project.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x]))+
  theme_light(base_size = 16) +
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank()
        ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA))+
  theme(axis.text.y = element_text(size=18), legend.position = "none")+
  ylab("mean dwelling [sec]")+
  labs(fill = "Outcome") +
  xlab("Experiment Sequence")+
  scale_fill_manual(values=c("red1", "steelblue4"))+
  scale_color_manual(values=c("firebrick4", "steelblue3"))+
  theme(panel.grid.major = element_line(colour = "#808080")) + 
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = 0, 
           alpha = .3)+
  ylim(dwellrange) +
  guides(fill = FALSE, size = FALSE)
}
 grid.arrange(grobs = dwellmeanplots)
```

```{r PIbar, eval=PIs, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 8, comment=NA, results='asis'}
cat("\n# Performance Indices\n \n## Performance Index bar plot with SEM:\n")

PIplots <- list()
for(x in 1:NofGroups)
  {
    PIprofile <- grouped.PIcombined[[x]] #get PIs (categories not used)

    # plot graph
     PIplots[[x]] <- ggplot(PIprofile, aes(x=period, y=PIs)) + 
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              stat_summary(geom = "bar", fun.y = mean, position = "dodge", fill=as.vector(na.omit(sequence$color)), colour="black", width=1) +
              stat_summary(geom = "errorbar", fun.data = mean_se, position = "dodge", width=0, size=2) +
              ggtitle(paste(project.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x])) +
              scale_y_continuous(breaks = seq(-1, 1, .2)) +
              theme_light(base_size = 16) + 
              theme(panel.grid.major.x = element_blank(),panel.grid.minor = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ 
              ylab("PI [rel. units]") + 
              xlab("Experiment Sequence") +
              theme(aspect.ratio=aspect_ratio)
  }
grid.arrange(grobs = PIplots, nrow=NofGroups)
```


```{r BoxWithNotch, eval=PIs, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 10, comment=NA, results='asis'}
cat("\n## Performance Index box&dotplot with notches:\n")

for(x in 1:NofGroups)
  {
    PIprofile <- grouped.PIcombined[[x]] #get PIs with categories

    #plot graph
    PIplots[[x]] <- ggplot(PIprofile, aes(period, PIs)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_boxplot(fill = as.vector(na.omit(sequence$color)), notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = PIprofile, aes(period, PIs, fill=category), position=position_jitter(0.3), shape=21, size=3, alpha=0.5) +
              ggtitle(paste(project.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x])) +
              scale_y_continuous(breaks = seq(-1, 1, .4)) +
              theme_light(base_size = 16) + 
              theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ 
              ylab("PI [rel. units]")+ 
              xlab("Experiment Sequence") + 
              theme(aspect.ratio=aspect_ratio) +
              scale_fill_discrete(name = "Categories") #legend title for categories 

    }  
grid.arrange(grobs = PIplots, nrow=NofGroups)
```


```{r BoxNoNotch, eval=PIs, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 10, comment=NA, results='asis'}
cat("\n## Performance Index box&dotplot without notches:\n")

for(x in 1:NofGroups)
  {
    PIprofile <- grouped.PIcombined[[x]] #get PIs with categories

    #plot graph
    PIplots[[x]] <- ggplot(PIprofile, aes(period, PIs)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_boxplot(fill = as.vector(na.omit(sequence$color)), notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = PIprofile, aes(period, PIs, fill=category), position=position_jitter(0.3), shape=21, size=3, alpha=0.5) +
              ggtitle(paste(project.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x])) +
              scale_y_continuous(breaks = seq(-1, 1, .4)) +
              theme_light(base_size = 16) + 
              theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ 
              ylab("PI [rel. units]")+ 
              xlab("Experiment Sequence") + 
              theme(aspect.ratio=aspect_ratio) +
              scale_fill_discrete(name = "Categories") #legend title for categories 

    }        
grid.arrange(grobs = PIplots, nrow=NofGroups)
```


```{r Violin, eval=PIs, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 8, comment=NA, results='asis'}
cat("\n## Performance Index Violin Plot:\n")

for(x in 1:NofGroups)
  {
  PIprofile <- grouped.PIcombined[[x]] #get PIs (categories not used)

    PIplots[[x]] <- ggplot(PIprofile, aes(period, PIs)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_violin(width = 1.1) +
              geom_boxplot(fill = as.vector(na.omit(sequence$color)), width = 0.1, outlier.color="darkred") +
              ggtitle(paste(project.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x])) +
              scale_y_continuous(breaks = seq(-1, 1, .4)) +
              theme_light(base_size = 16) + 
              theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ 
              ylab("PI [rel. units]")+ 
              xlab("Experiment Sequence") + 
              theme(aspect.ratio=aspect_ratio)
  }
grid.arrange(grobs = PIplots, nrow=NofGroups)
```


```{r Wilcoxon, eval=wil, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.height = 6, fig.width = 12, comment=NA, results='asis'}
cat("\n# Learning Score Statistics\n## Statistical tests of single groups against zero\n")
  
  wilcoxon<-numeric()  
  for(x in 1:NofGroups){wilcoxon[x] = signif(wilcox.test(PIstat[[x]])$p.value, 3)} #test all groups against zero
  #compute Bayes Factor for single group 
  if(NofGroups==1){
    results.bayes=extractBF(ttestBF(na.omit(PIstat[[1]])))
    results.bayes <- results.bayes[-c(3,4)] # drop the date and code columns
    row.names(results.bayes) <- groupnames #group name as row name
    results.bayes <- signif(results.bayes, digits=3) # reduce results to 3 significant digits
    } else { #compute Bayes Factors for several groups
          results.bayes<-list()
          for(x in 1:NofGroups){results.bayes[[x]]=extractBF(ttestBF(na.omit(PIstat[[x]])))} #extract BayesFactors for all groups
          results.bayes<-do.call("rbind", results.bayes) #fuse all Bayes results into one dataframe
          results.bayes <- results.bayes[-c(3,4)]# drop the date and code columns
          row.names(results.bayes) <- groupnames #group name as row name
          results.bayes <- signif(results.bayes, digits=3) # reduce results to 3 significant digits
    }
# plot PI box plot test against zero
  plots.singles<-list(ggplot(PIstatCombined, aes(group, PIs)) +
    geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
    geom_boxplot(fill = boxcolors, notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
    ggtitle("Wilcoxon") +
    geom_jitter(data=PIstatCombined, aes(group, PIs, fill=category), position=position_jitter(0.3), shape=21, size=3, alpha=0.5) +
    scale_y_continuous(breaks = seq(-1, 1, .2)) +
    theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA), legend.position = "top",legend.title = element_blank()) +
    theme(axis.text.y = element_text(size=18))+ ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
    samplesizes.annotate(boxes, samplesizes) +
    wilcox.annotate(boxes, wilcoxon))
  
  
#add table with results and plot
    plots.singles[[2]]<-tableGrob(results.bayes)
    grid.arrange(grobs = plots.singles, ncol=2)
```

```{r Utest, eval=(PIs & twogroupstats & NofGroups==2), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 10, comment=NA, results='asis'}
cat("\n## Statistical tests between two groups\n")

    utest = signif(wilcox.test(PIstat[[1]],PIstat[[2]])$p.value, 3) #compare the two groups with a U-test and collect p-value
    w.statistic = signif(wilcox.test(PIstat[[1]],PIstat[[2]])$statistic, 3)
    #compute effect size Cohen's D
    if(samplesizes[1]==samplesizes[2]){equalN=TRUE}else{equalN=FALSE}   #deterine if the samplesizes are identical
    if(fligner.test(PIstatCombined$PIs,PIstatCombined$group)$p.value<0.05){hv=FALSE}else{hv=TRUE}       #test for homogeneity of variance and set hv TRUE/FALSE
    if(equalN & hv){hedges=FALSE}else{hedges=TRUE}                      #test if we need to apply Hedge's correction
    if(hedges){
      cohend = signif(cohen.d(PIstatCombined$PIs, PIstatCombined$group, hedges.correction = hedges)$estimate, 3) #use effsize package for Hedge's correction
    }else{
      cohend = signif((mean(na.omit(PIstat[[1]]))-mean(na.omit(PIstat[[2]])))/sqrt((sd(na.omit(PIstat[[1]]))^2+sd(na.omit(PIstat[[2]]))^2)/2), 3) #use simple formula if variances and sample sizes are identical
    }
    #calculate statistical power
    alt = project.data[["statistics"]][["two.groups"]][["power"]]
    power=signif(pwr.t2n.test(n1 = samplesizes[1], n2= samplesizes[2], d = cohend, alternative = alt, sig.level = signif[1])$power, 3)
    #calculate Bayes Factor
    bayesF=extractBF(ttestBF(na.omit(PIstat[[1]]), na.omit(PIstat[[2]])))
    #calculate FPR for priors set in project file#
    #run first prior  
      prior=priorval[1]
      out=calc.FPR(samplesizes,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz1=out[1]
    #run second prior  
      prior=priorval[2]
      out=calc.FPR(samplesizes,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz2=out[1]
    #Power and likelihood ratio: NB for two sided test, need 2*y0
      LR=out[5]/(2*out[3])        #lik ratio (Hi1/H0) =y1/2*y0

      #make tidy table of results
    results.utest<-data.frame(values=c(signif[1],
                                       w.statistic,
                                       cohend,
                                       power,
                                       signif(bayesF$bf, 3),
                                       signif(bayesF$error, 3),
                                       signif(fpz1, 3),
                                       signif(fpz2, 3),
                                       signif(LR, 3)))
    rownames(results.utest)<-c("Significance level",
                               "MW U-Test, W",
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")
    
# plot two PIs with asterisks
  plots.2test<-list(ggplot(PIstatCombined, aes(group, PIs)) +
      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
      geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
      geom_jitter(data=PIstatCombined, aes(group, PIs, fill=category), position=position_jitter(0.3), shape=21, size=3, alpha=0.5) +
      ggtitle(paste("U-Test, p=", utest)) +
      scale_y_continuous(breaks = seq(-1, 1, .2)) +
      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
      theme(axis.text.y = element_text(size=18))+ ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=4/NofGroups)+
      geom_signif(comparisons = list(c(colnames(PIstat[1]), colnames(PIstat[2]))), 
                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                  textsize=8, vjust=0.5) +
      samplesizes.annotate(boxes, samplesizes))
  

  #add table with results and plot
  plots.2test[[2]]<-tableGrob(results.utest)
  grid.arrange(grobs = plots.2test, ncol=2)

```

```{r estimationstats, eval=(PIs & twogroupstats & NofGroups==2), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}
cat("\n## Estimation statistics\n")
unpaired_median_diff <- dabest(PIstatCombined, group, PIs, idx = groupnames, paired = FALSE, func = median) #create estimation results list
print(plot(unpaired_median_diff)) #plot results
```

```{r splitviolins, eval=(PIs & twogroupstats & NofGroups==2), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}
cat("\n## Split Violin Plot\n")

PIstatCombined$learningscore=project.data$statistics$`learning-score`$title #add x-axis value for split violin plots
print(ggplot(PIstatCombined, aes(learningscore, PIs, fill = group)) + scale_fill_manual(values=boxcolors) + geom_split_violin()) #plot spit violin plot

```

```{r UtestG3, eval=(PIs & threegroupstats & NofGroups==3), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 12, comment=NA, results='asis'}
cat("\n## Statistical tests between three groups\n")
#creating a list with PIs and condition in on list
PItype <- list() 
for (x in 1:NofGroups){
  PItype[[x]] = melt(PIstat[[x]])
  PItype[[x]]$desc = project.data$resources[[x]]$description
  PItype[[x]]$name = project.data$resources[[x]]$name
}
#groupe in experimental and driver groupe
Count=1
Control=list()
Exp=list()
for (t in 1:NofGroups) {
  if(grepl("test", tolower(PItype[[t]]$desc)) | grepl("exp", tolower(PItype[[t]]$desc)) | grepl("experimental", tolower(PItype[[t]]$desc))==TRUE){
    Exp = na.omit(PItype[[t]])
  } else {
    Control[[Count]] =na.omit(PItype[[t]])
    Count=Count+1
  }
}
PIname<-c(unique(Exp$name), unique(Control[[1]]$name),unique(Control[[2]]$name))
#drop second column
Exp<-Exp[ , (names(Exp) %in% "value")]
Control<-lapply(Control, "[[", "value")

#groupe 3 (experimental) vs the other two groups
utest1 = signif(wilcox.test(Exp,Control[[1]])$p.value, 3)
utest2 = signif(wilcox.test(Exp,Control[[2]])$p.value, 3)#compare the two groups with a U-test and collect p-value
w.statistic1 = signif(wilcox.test(Exp,Control[[1]])$statistic, 3)
w.statistic2 = signif(wilcox.test(Exp,Control[[2]])$statistic, 3)
#compute effect size Cohen's D
cohend1 = signif(cohen.d(Exp, Control[[1]])$estimate, 3)
cohend2 = signif(cohen.d(Exp, Control[[2]])$estimate, 3)
#calculate statistical power
alt = project.data[["statistics"]][["three.groups"]][["power"]]
power1=signif(pwr.t2n.test(n1 = length(Exp), n2= length(Control[[1]]), d = cohend1, alternative = alt, sig.level = signif[1])$power, 3)
power2=signif(pwr.t2n.test(n1 = length(Exp), n2= length(Control[[2]]), d = cohend2, alternative = alt, sig.level = signif[1])$power, 3)
#calculate Bayes Factor
bayesF1=extractBF(ttestBF(Exp, Control[[1]]))
bayesF2=extractBF(ttestBF(Exp, Control[[2]]))
#calculate FPR for priors set in project file#
#run first prior  
prior=priorval[1]
out1=calc.FPR(samplesizes,utest1,prior,abs(cohend1))  #output=c(FPR,x0,y0,x1,y1)
fpz1=out1[1]
#run second prior  
prior=priorval[2]
out1=calc.FPR(samplesizes,utest1,prior,abs(cohend1))  #output=c(FPR,x0,y0,x1,y1)
fpz2=out1[1]
#run first prior  
prior=priorval[1]
out2=calc.FPR(samplesizes,utest2,prior,abs(cohend2))  #output=c(FPR,x0,y0,x1,y1)
fpz3=out2[1]
#run second prior
prior=priorval[2]
out2=calc.FPR(samplesizes,utest2,prior,abs(cohend2))  #output=c(FPR,x0,y0,x1,y1)
fpz4=out2[1]
#Power and likelihood ratio: NB for two sided test, need 2*y0
LR1=out1[5]/(2*out1[3])        #lik ratio (Hi1/H0) =y1/2*y0
LR2=out2[5]/(2*out2[3])
#make tidy table of results
results.utest<-(cbind(TestxCont1=c(signif[1],
                                   w.statistic1,
                                   utest1,
                                   cohend1,
                                   power1,
                                   signif(bayesF1$bf, 3),
                                   signif(bayesF1$error, 3),
                                   signif(fpz1, 3),
                                   signif(fpz2, 3),
                                   signif(LR1, 3)),
                      TestxCont2=c(signif[1],
                                   w.statistic2,
                                   utest2,
                                   cohend2,
                                   power2,
                                   signif(bayesF2$bf, 3),
                                   signif(bayesF2$error, 3),
                                   signif(fpz3, 3),
                                   signif(fpz4, 3),
                                   signif(LR2, 3))))
colnames(results.utest) = c(paste(PIname[1], PIname[2]),paste(PIname[1], PIname[3]))  
                               
    

rownames(results.utest)<-c("Significance level",
                               "MW U-Test, W",
                               "U-Test p-value", 
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")
    
# plot two PIs with asterisks
plots.2test<-ggplot(PIstatCombined, aes(group, PIs)) +
                    geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
                    geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
                    geom_jitter(data=PIstatCombined, aes(group, PIs, fill=category), 
                                position=position_jitter(0.3), shape=21, size=3) +
                    scale_y_continuous(breaks = seq(-1, 1, .2)) +
                    theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                                                        panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black",
                                                        fill=NA), legend.position = "top", 
                                                        legend.title = element_blank()) +
                    theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+ 
                    ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
                    geom_signif(comparisons = list(c(colnames(PIstat[2]), colnames(PIstat[3]))), 
                                map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                                textsize=5, vjust=0.1) +
                    geom_signif(comparisons = list(c(colnames(PIstat[1]), colnames(PIstat[3]))), 
                                map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                                textsize=5, vjust=0.1, y_position =1.2) +
                    ylim(c(-1, 1.3)) +
                    samplesizes.annotate(boxes, samplesizes)

  #add table with results and plot
  plots.2utest<-tableGrob(results.utest)
  #plot_grid(plots.2test, plots.2utest, ncol = 2)
  grid.arrange(plots.2test,plots.2utest, nrow = 1)
  #ggarrange(plots.2test, plots.2utest, ncol = 2)
  

```

```{r Utestpooled, eval=(PIs & twogroupstats & PoolGrps), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 12, comment=NA, results='asis'}
cat("\n## Statistical tests between pooled groups\n")

  cat("The following experimental groups were pooled into two groups:\n")
reactable(PooledGroups,
  striped = TRUE,
  highlight = TRUE,
  bordered = TRUE,
  resizable = TRUE,
  compact = TRUE,
  fullWidth = FALSE)

    utest = signif(wilcox.test(PIprofilePooled[[1]],PIprofilePooled[[2]])$p.value, 3) #compare the two groups with a U-test and collect p-value
    w.statistic = signif(wilcox.test(PIprofilePooled[[1]],PIprofilePooled[[2]])$statistic, 3)
    #compute effect size Cohen's D
    if(samplesizes[1]==samplesizes[2]){equalN=TRUE}else{equalN=FALSE}   #deterine if the samplesizes are identical
    if(fligner.test(PIstatPooled$PIs,PIstatPooled$group)$p.value<0.05){hv=FALSE}else{hv=TRUE}       #test for homogeneity of variance and set hv TRUE/FALSE
    if(equalN & hv){hedges=FALSE}else{hedges=TRUE}                      #test if we need to apply Hedge's correction
    if(hedges){
      cohend = signif(cohen.d(PIstatPooled$PIs, PIstatPooled$group, hedges.correction = hedges)$estimate, 3) #use effsize package for Hedge's correction
    }else{
      cohend = signif((mean(na.omit(PIprofilePooled[[1]]))-mean(na.omit(PIprofilePooled[[2]])))/sqrt((sd(na.omit(PIprofilePooled[[1]]))^2+sd(na.omit(PIprofilePooled[[2]]))^2)/2), 3) #use simple formula if variances and sample sizes are identical
    }
    #calculate statistical power
    alt = project.data[["statistics"]][["two.groups"]][["power"]]
    power=signif(pwr.t2n.test(n1 = samplesizesPooled[1], n2= samplesizesPooled[2], d = cohend, alternative = alt, sig.level = signif[1])$power, 3)
    #calculate Bayes Factor
    bayesF=extractBF(ttestBF(na.omit(PIprofilePooled[[1]]), na.omit(PIprofilePooled[[2]])))
    #calculate FPR for priors set in project file#
    #run first prior  
      prior=priorval[1]
      out=calc.FPR(samplesizesPooled,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz1=out[1]
    #run second prior  
      prior=priorval[2]
      out=calc.FPR(samplesizesPooled,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz2=out[1]
    #Power and likelihood ratio: NB for two sided test, need 2*y0
      LR=out[5]/(2*out[3])        #lik ratio (Hi1/H0) =y1/2*y0

      #make tidy table of results
    results.utest<-data.frame(values=c(signif[1],
                                       w.statistic,
                                       cohend,
                                       power,
                                       signif(bayesF$bf, 3),
                                       signif(bayesF$error, 3),
                                       signif(fpz1, 3),
                                       signif(fpz2, 3),
                                       signif(LR, 3)))
    rownames(results.utest)<-c("Significance level",
                               "MW U-Test, W",
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")
    
# plot two PIs with asterisks
  plots.2test<-list(ggplot(PIstatPooled, aes(group, PIs)) +
      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
      geom_boxplot(fill = boxcolors[1:2], notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
      geom_jitter(data=PIstatPooled, aes(group, PIs, fill=category), position=position_jitter(0.3), shape=21, size=3) +
      ggtitle(paste("U-Test, p=", utest)) +
      scale_y_continuous(breaks = seq(-1, 1, .2)) +
      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA), legend.position = "bottom") +
      theme(axis.text.y = element_text(size=18))+ ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=1)+
      geom_signif(comparisons = list(c(colnames(PIprofilePooled[1]), colnames(PIprofilePooled[2]))), 
                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                  textsize=8, vjust=0.5) +
      samplesizes.annotate(boxes[1:2], samplesizesPooled))
  

  #add table with results and plot
  plots.2test[[2]]<-tableGrob(results.utest)
  grid.arrange(grobs = plots.2test, ncol=2)

```

```{r estimationstatspooled, eval=(PIs & twogroupstats & PoolGrps), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}
 cat("\n## Estimation statistics for pooled groups\n")
 groupnames=unique(groupdescriptions) #rename groupnames to pooled groups specifically for dabestr
 unpaired_median_diff <- dabest(PIstatPooled, group, PIs, idx = groupnames, paired = FALSE, func = median) #create estimation results list
 print(plot(unpaired_median_diff)) #plot results

```

```{r splitviolinspooled, eval=(PIs & twogroupstats & PoolGrps), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}
cat("\n## Split Violin Plot for pooled groups\n")

PIstatPooled$learningscore=project.data$statistics$`learning-score`$title #add x-axis value for split violin plots
print(ggplot(PIstatPooled, aes(learningscore, PIs, fill = group)) + scale_fill_manual(values=boxcolors) + geom_split_violin()) #plot spit violin plot

```