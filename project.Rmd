<style type="text/css">
  body .main-container {
    max-width: 1800px !important;
  }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, packages, eval=FALSE, echo=FALSE}
# load packages 
library(ggplot2)
library(tidyr)
library(dygraphs)
library(grid)
library(reshape2)
library(dplyr)
library(gridExtra)
library(yaml)
library(ggsignif)
library(effsize)
library(pwr)
library(BayesFactor)
library(genefilter) # if not available for newest version: setRepositories(addURLs = c(CRANxtras = "http://www.stats.ox.ac.uk/pub/RWin"))
library(seewave)
library(lubridate)

## source the script with the functions needed for analysis
source("readXMLdatafile.R")
source("DTS_plotfunctions.R")
```

<center><h1><i>Drosophila</i> Time Series Project Data Evaluation Sheet</h1></center>
<center><h2>for time series data set: "<b>`r paste(project.data$title)`</b>"</h2></center>

### 1. Metadata:

**Description:** `r paste(project.data$description)`  
**Experimenter:** `r paste(experimenter$firstname, experimenter$lastname, sep = " ")`; **ORCID:** [`r paste(experimenter$orcid)`](http://orcid.org/`r paste(experimenter$orcid)`)  
**Experiment duration:** `r paste(seconds_to_period(as.numeric(as.character(experiment$duration))))`  

### 2. Experimental Design:
```{r expdesign, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 3, fig.width = 9}
#Write table of period design
periods <- periods[-6,]
periods[3,periods["outcome",]==0]="test"
periods[3,periods["outcome",]==1]="training"
grid.table(periods)
```

```{r typePrep, echo=FALSE}
 ###determine if platform or torque data
type_no_platform <- isFALSE(sequence$type[1] == "OptomotoL" | sequence$type[1] == "OptomotoR")
type_is_platform <- isTRUE(sequence$type[1] == "OptomotoL" | sequence$type[1] == "OptomotoR")
```

### 3. Torque Histograms:

```{r TorqueHistograms, eval=type_no_platform, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    
  for(x in 1:NofGroups)
    {
      cat("<center><h4>",project.data[["resources"]][[x]][["title"]],"</h4></center>")
      trqhistos <- grouped.trqhistos[[x]]
      multiplot(plotlist = trqhistos, cols=2) #torquehistos
  }  
```

### 3. Platform Histograms:

```{r TorqueHistogram, eval=type_is_platform, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    
  for(x in 1:NofGroups)
    {
      cat("<center><h4>",project.data[["resources"]][[x]][["title"]],"</h4></center>")
      flyhistos <- grouped.flyhistos[[x]]
      multiplot(plotlist = flyhistos, cols=4)
      # 
      # cat("<center><h4>",project.data[["resources"]][[x]][["title"]],"</h4></center>")
      # flyhistosL <- grouped.flyhistosL[[x]]
      # multiplot(plotlist = flyhistosL, cols=4)
      # 
      # cat("<center><h4>",project.data[["resources"]][[x]][["title"]],"</h4></center>")
      # flyhistosR <- grouped.flyhistosR[[x]]
      # multiplot(plotlist = flyhistosR, cols=4)
  }  
```

### 4. Position Histograms:

```{r PositionHistogram, eval=type_no_platform, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    
  for(x in 1:NofGroups)
    {
      cat("<center><h4>",project.data[["resources"]][[x]][["title"]],"</h4></center>")
      poshistos <- grouped.poshistos[[x]]
      multiplot(plotlist = poshistos, cols=2) #positionhistos
  }
```

### 5. Fourier Spectrum Analysis

```{r spectra, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8}
spectemp <- do.call("rbind", grouped.spectra) #create single data.frame with grouping variable from list of groups
print(ggplot(spectemp, aes(x=freq, y=mean, group = group)) + 
        geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd, fill = group), alpha=0.5) +
        scale_fill_manual(values = boxcolors) +
        geom_line(aes(colour = group), size = 2) + 
        scale_color_manual(values = boxcolors) +
        scale_x_continuous(breaks = seq(0, 10, 2), limits = c(0, 10), expand=c(0,0)) +
        scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1), expand=c(0,0)) +
        ggtitle("Powerspectra") +
        guides(colour = guide_legend(override.aes = list(size=3))) +
        theme_light(base_size = 16) + theme(legend.justification=c(1,0),
                                            legend.position=c(0.94,0.60), 
                                            legend.title=element_blank(), 
                                            legend.key.size = unit(2, 'lines'),
                                            legend.key = element_rect(size = 6),
                                            legend.box.background = element_rect(fill="white"),
                                            legend.box.margin = margin(4, 4, 4, 4),
                                            legend.text=element_text(size=14), 
                                            panel.grid.major.y = element_blank(),
                                            panel.grid.minor = element_blank(),
                                            panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
        theme(axis.text.y = element_text(size=12))+ ylab("mean rel. Power") + xlab("Frequency [Hz]"))
```


### 6. Performance Index bar plot with SEM:

```{r PIbar, eval=type_no_platform, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 8, fig.width = 8}
PIplots <- list()
for(x in 1:NofGroups)
  {
    PIprofile <- grouped.PIprofiles[[x]]
      # compute summary statistics
      error <- data.frame(period=integer(ncol(PIprofile)), mean=numeric(ncol(PIprofile)), sem=numeric(ncol(PIprofile)))
      for(e in 1:ncol(PIprofile))
      {
        error$period[e]=e
        error$mean[e]=mean(PIprofile[,e])
        error$sem[e]=sd(PIprofile[,e]/sqrt(nrow(PIprofile)))
      }
      # plot graph
     PIplots[[x]] <- ggplot(error, aes(x=period, y=mean)) + 
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_bar(fill = sequence$color, position=position_dodge(), stat="identity", colour="black") +
              geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),
                            width=0,
                            size=1.5,
                            position=position_dodge(.9)) +
              ggtitle(paste(project.data[["resources"]][[x]][["title"]], ", N=",nrow(PIprofile))) +
              scale_x_continuous(breaks = seq(1, NofPeriods, 1)) +
              scale_y_continuous(breaks = seq(-1, 1, .2)) +
              theme_light(base_size = 16) + theme(panel.grid.major.x = element_blank(),panel.grid.minor = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=16))+ ylab("PI [rel. units]") + theme(aspect.ratio=4/NofPeriods)
  }
grid.arrange(grobs = PIplots, nrow=NofGroups)
```

### 7. Performance Index box&dotplot with notches:

```{r BoxWithNotch, eval=type_no_platform, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 8, fig.width = 8}
for(x in 1:NofGroups)
  {
  PIprofile <- grouped.PIprofiles[[x]]
    PIplots[[x]] <- ggplot(melt(PIprofile), aes(variable, value)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_boxplot(fill = sequence$color, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = melt(PIprofile), aes(variable, value), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
              ggtitle(paste(project.data[["resources"]][[x]][["title"]], ", N=",nrow(PIprofile))) +
              scale_y_continuous(breaks = seq(-1, 1, .4)) +
              theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ ylab("PI [rel. units]")+ xlab("Experiment Sequence") + theme(aspect.ratio=4/NofPeriods)
  }  
grid.arrange(grobs = PIplots, nrow=NofGroups)
```

### 8. Performance Index box&dotplot without notches:

```{r BoxNoNotch, eval=type_no_platform, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 8, fig.width = 8}
for(x in 1:NofGroups)
  {
  PIprofile <- grouped.PIprofiles[[x]]
    PIplots[[x]] <- ggplot(melt(PIprofile), aes(variable, value)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_boxplot(fill = sequence$color, notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = melt(PIprofile), aes(variable, value), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
              ggtitle(paste(project.data[["resources"]][[x]][["title"]], ", N=",nrow(PIprofile))) +
              scale_y_continuous(breaks = seq(-1, 1, .4)) +
              theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ ylab("PI [rel. units]")+ xlab("Experiment Sequence") + theme(aspect.ratio=4/NofPeriods)
  }      
grid.arrange(grobs = PIplots, nrow=NofGroups)
```

### 9. Performance Index Violin Plot:

```{r Violin, eval=type_no_platform, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 8, fig.width = 8}
for(x in 1:NofGroups)
  {
  PIprofile <- grouped.PIprofiles[[x]]
    PIplots[[x]] <- ggplot(melt(PIprofile), aes(variable, value)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_violin(width = 1.1) +
              geom_boxplot(fill = sequence$color, width = 0.1, outlier.color="darkred") +
              ggtitle(paste(project.data[["resources"]][[x]][["title"]], ", N=",nrow(PIprofile))) +
              scale_y_continuous(breaks = seq(-1, 1, .4)) +
              theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ ylab("PI [rel. units]")+ xlab("Experiment Sequence") + theme(aspect.ratio=4/NofPeriods)
  }
grid.arrange(grobs = PIplots, nrow=NofGroups)
```


```{r StatSetup, echo=FALSE}
stat <- !is.null(project.data[["statistics"]]) ###determine if stats are requested
```

```{r StatPrep, eval=(stat & type_no_platform), echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
signif = project.data[["statistics"]][["significance-levels"]] #get significance levels
priorval = project.data[["statistics"]][["priors"]]# get priors for FPR calculation
learningscore=project.data[["statistics"]][["learning-score"]][["data"]] #get the PI that is going to be tested
groupnames <- unlist(sapply(project.data[["resources"]], function(x) x["name"])) #get a vector with all group names

#create new dataframe with only the chosen PI values
PIstat <- list()
for(x in 1:NofGroups){PIstat[[x]] <- grouped.PIprofiles[[x]][[learningscore]]}
PIstat <- as.data.frame(t(plyr::ldply(PIstat, rbind))) #convert PI list to data.frame
colnames(PIstat) <- unlist(sapply(project.data[["resources"]], '[', 'name')) #add group names as column names to PIstat
#get easy to access sample sizes
samplesizes<-as.numeric(apply(PIstat, 2, function(x) length(na.omit(x))))
#get easy access to standard deviations
SDs<-as.numeric(apply(PIstat, 2, function(x) sd(na.omit(x))))
```

```{r WilcoxonSetup, echo=FALSE}
wil <- isTRUE(project.data[["statistics"]][["single.groups"]][["data"]]==1) ###determine if we need to do single tests
```

```{r Wilcoxon, eval=(wil & type_no_platform), echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}
cat("### 10. Statistical Tests of single groups against zero:")

  wilcoxon<-numeric()  
  for(x in 1:NofGroups){wilcoxon[x] = signif(wilcox.test(PIstat[[x]])$p.value, 3)} #test all groups against zero
  #compute Bayes Factor for each group
  results.bayes<-list()
  for(x in 1:NofGroups){results.bayes[[x]]=extractBF(ttestBF(na.omit(PIstat[[x]])))} #extract BayesFactors for all groups
  results.bayes<-do.call("rbind", results.bayes) #fuse all Bayes results into one dataframe
  results.bayes <- results.bayes[-c(3,4)]# drop the date and code columns
  results.bayes <- as.data.frame(sapply(results.bayes , signif, 3)) # reduce results to 3 significant digits
  #add group names as row names
  row.names(results.bayes) <- groupnames

# plot PI box plot test against zero
  plots.singles<-list(ggplot(melt(PIstat), aes(variable, value)) +
    geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
    geom_boxplot(fill = boxcolors, notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
    geom_jitter(data = melt(PIstat), aes(variable, value), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
    ggtitle("Wilcoxon") +
    scale_y_continuous(breaks = seq(-1, 1, .2)) +
    theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
    theme(axis.text.y = element_text(size=18))+ ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
    samplesizes.annotate(boxes, samplesizes) +
    wilcox.annotate(boxes, wilcoxon))
  
#add table with results and plot
    plots.singles[[2]]<-tableGrob(results.bayes)
    grid.arrange(grobs = plots.singles, ncol=2)
```


```{r utestSetup, echo=FALSE}
two <- isTRUE(project.data[["statistics"]][["two.groups"]][["data"]]==1 || NofGroups==2) ###determine if we need to do between groups tests
```
      
```{r Utest, eval=(two & type_no_platform), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}
cat("### 11. Statistical Tests between two groups:")

    utest = signif(wilcox.test(PIstat[[1]],PIstat[[2]])$p.value, 3) #compare the two groups with a U-test and collect p-value
    w.statistic = signif(wilcox.test(PIstat[[1]],PIstat[[2]])$statistic, 3)
    #compute effect size Cohen's D
    cohend = signif(cohen.d(na.omit(PIstat[,1]), na.omit(PIstat[,2]))$estimate, 3)
    #calculate statistical power
    alt = project.data[["statistics"]][["two.groups"]][["power"]]
    power=signif(pwr.t2n.test(n1 = samplesizes[1], n2= samplesizes[2], d = cohend, alternative = alt, sig.level = signif[1])$power, 3)
    #calculate Bayes Factor
    bayesF=extractBF(ttestBF(na.omit(PIstat[[1]]), na.omit(PIstat[[2]])))
    #calculate FPR for priors set in project file#
    #run first prior  
      prior=priorval[1]
      out=calc.FPR(samplesizes,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz1=out[1]
    #run second prior  
      prior=priorval[2]
      out=calc.FPR(samplesizes,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz2=out[1]
    #Power and likelihood ratio: NB for two sided test, need 2*y0
      LR=out[5]/(2*out[3])        #lik ratio (Hi1/H0) =y1/2*y0

      #make tidy table of results
    results.utest<-data.frame(values=c(signif[1],
                                       w.statistic,
                                       cohend,
                                       power,
                                       signif(bayesF$bf, 3),
                                       signif(bayesF$error, 3),
                                       signif(fpz1, 3),
                                       signif(fpz2, 3),
                                       signif(LR, 3)))
    rownames(results.utest)<-c("Significance level",
                               "MW U-Test, W",
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")
    
# plot two PIs with asterisks
  plots.2test<-list(ggplot(melt(PIstat), aes(variable, value)) +
      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
      geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
      geom_jitter(data = melt(PIstat), aes(variable, value), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
      ggtitle(paste("U-Test, p=", utest)) +
      scale_y_continuous(breaks = seq(-1, 1, .2)) +
      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
      theme(axis.text.y = element_text(size=18))+ ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
      geom_signif(comparisons = list(c(colnames(PIstat[1]), colnames(PIstat[2]))), 
                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                  textsize=8, vjust=0.5) +
      samplesizes.annotate(boxes, samplesizes))

  #add table with results and plot
  plots.2test[[2]]<-tableGrob(results.utest)
  grid.arrange(grobs = plots.2test, ncol=2)

```

