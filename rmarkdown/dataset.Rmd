---
title: "*Drosophila* Time Series - Dataset Evaluation Sheet"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float: true
    keep_md: FALSE
---
<style type="text/css">
  body .main-container {
    max-width: 1800px !important;
  }
  h1.title {
  font-size: 38px;
  color: DarkRed;
  text-align: center;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, setwd, eval=FALSE, echo=FALSE}
setwd(dataset.path)
```

<center><h2>for time series dataset: "<b>`r paste(dataset.data$experiment$title)`</b>"</h2></center>
<center>Rendered on `r format(Sys.time(), '%d %B %Y')`</center>

# Metadata

**dataset file (YAML):** `r paste('<a href="', basename(dataset.file), '">', dataset.data$experiment$title, '</a>', sep = "")`  
**Description:** `r paste(dataset.data$experiment$description)`  
**Measurement RRID:** `r paste('<a href="https://scicrunch.org/resolver/RRID:', dataset.data$experiment$id, '">', dataset.data$experiment$id, '</a>', sep = "")`  
**Experimenter:** `r paste(experimenter$firstname, experimenter$lastname, sep = " ")`; **ORCID:** [`r paste(experimenter$orcid)`](http://orcid.org/`r paste(experimenter$orcid)`)  
**Experiment duration:** `r paste(seconds_to_period(as.numeric(as.character(experiment$duration))))`  

# Experimental Sequence
```{r expdesign, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = (round(NofPeriods/3)), fig.width = NofPeriods+1}
#Write table of period design
periods <- periods[-6,]
periods[3,periods["outcome",]==0]="test"
periods[3,periods["outcome",]==1]="training"
reactable(setDT(as.data.frame(periods), keep.rownames = "property")[],
  striped = TRUE,
  highlight = TRUE,
  bordered = TRUE,
  resizable = TRUE,
  compact = TRUE,
  columns = list(property = colDef(style = list(position = "sticky", left = 0, background = "#fff", zIndex = 1),
    headerStyle = list(position = "sticky", left = 0, background = "#fff", zIndex = 1))))
```

```{r Graphdim, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
len = as.integer(lengths(dataset.data["resources"])*5)
aspect_ratio = 4/nrow(sequence %>% na.omit())
```

# Experimental groups and single fly evaluations

**Number of experimental groups:** `r paste(NofGroups)`
```{r singleflydata, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
exp_groups <- as.data.frame(sapply(exp_groups, '[', seq(max(lengths(exp_groups))))) #make dataframe from list
colnames(exp_groups) = as.character(exp_groups[1, ]) # make group names to column names
if(!is.null(groupids)){exp_groups[1, ] <- groupids}else{exp_groups <- tail(exp_groups,-1)} 
rownames(exp_groups) <- NULL #remove the numbers
#plot table with links to individual fly evaluations
reactable(exp_groups,
  striped = TRUE,
  highlight = TRUE,
  bordered = TRUE,
  resizable = TRUE,
  compact = TRUE,
  fullWidth = FALSE,
  defaultColDef = colDef(html = TRUE), 
  defaultPageSize = 45)
```

# Histograms
## Fly Behavior Histograms

```{r FlyHistogram, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

for(x in 1:NofGroups)
  {
    cat("<center><h4>",dataset.data[["resources"]][[x]][["title"]],"</h4></center>")
    par(mfrow=c(ceiling((NofPeriods+1)/3),3)) # sets the dimension of the multiplot, row x column
    old.par = par(mar = c(3, 4, 1, 2))
    grouphistdata[[x]]$period =as.factor(grouphistdata[[x]]$period)
    
  for (i in 1:NofPeriods){
      df = subset(grouphistdata[[x]], grouphistdata[[x]]$period == i)
      hist(x = df$fly, breaks = 4000,xlim = c(-600,600), xlab="", border= sequence$histocolor[i],  col = sequence$histocolor[i], main=paste("Period ", i)) #plot histogram
      if(any(c("yt","sw") %in% sequence$type[i])) {
      rect(-2000, 0, 0, 50000, col=("lightgrey")) #shade negative torque range as heated
      hist(x = df$fly, breaks = 4000,xlim = maxfly, xlab="", border= sequence$histocolor[i],  col = sequence$histocolor[i], main=paste("Period ", i), add=TRUE) #plot histogram again
  }
      abline(v = 0, col="black", lwd=2, lty=2)
  }
    hist(grouphistdata[[x]]$fly, breaks = 300,xlim = c(-600,600), xlab=paste(FlyBehavior, "[arb units]"), main=paste("Pooled Behavior Histogram", groupnames[[x]]))
  }  

```


```{r PositionHistogram, eval=('fs' %in% sequence$type || 'color' %in% sequence$type), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    
cat("\n## Arena Position Histograms\n")
for(x in 1:NofGroups)
  {
    cat("<center><h4>",dataset.data[["resources"]][[x]][["title"]],"</h4></center>")
    par(mfrow=c(round((NofPeriods+1)/2),2)) # sets the dimension of the multiplot, row x column
    old.par = par(mar = c(4, 4, 1, 2))
    grouphistdata[[x]]$period =as.factor(grouphistdata[[x]]$period)
    
  for (i in 1:NofPeriods){
      df = subset(grouphistdata[[x]], grouphistdata[[x]]$period == i)
      hist(x = df$a_pos, breaks = 360,xlim = c(-1800,1800), xlab="", ylab = "", border= sequence$histocolor[i],  col = sequence$histocolor[i], main=paste("Period ", i), xaxt='n', yaxs="i") #plots histogram
    #add quadrant shading
      rect(-1800, 0, -1350, 8000, col=("lightgrey"))
      rect(-450, 0, 450, 8000, col=("lightgrey"))
      rect(1350, 0, 1800, 8000, col=("lightgrey"))
      hist(x = df$a_pos, breaks = 360,xlim = c(-1800,1800), xlab="", ylab = "", border= sequence$histocolor[i],  col = sequence$histocolor[i], main=paste("Period ", i), add = TRUE) #plots histogram again
      abline(v = 0, col="black", lwd=1, lty="dotted") # adds a line at 0
      abline(v = 900, col="black", lwd=1, lty="dotted") # adds a line at 90°  
      abline(v = -900, col="black", lwd=1, lty="dotted") # adds a line at -90° 
      axis(side=1, at=c(-1800, -900, 0, 900, 1800))
      mtext(text = paste("Arena Position [degrees*10]"),
            cex = 1,
          side = 1,#side 1 = bottom
          line = 2.5)
      mtext(text = "Frequency",
            cex = 1,
          side = 2, #side 2 = left
          line = 2)
  }
  #add pooled histogram
  hist(grouphistdata[[x]]$a_pos, breaks = 360, border = "grey40", col = "grey40", xlab="", ylab="", main=paste("Pooled Position Histogram", groupnames[[x]]), xaxt='n', yaxs="i")
    axis(side=1, at=c(-1800, -900, 0, 900, 1800))
    #add quadrant borders
    abline(v = -1350, col="black", lwd=1, lty="dotted") # adds a line at -135°
    abline(v = -450, col="black", lwd=1, lty="dotted") # adds a line at -45° 
    abline(v = 450, col="black", lwd=1, lty="dotted") # adds a line at 45° 
    abline(v = 1350, col="black", lwd=1, lty="dotted") # adds a line at 135° 
    
    mtext(text = paste("Arena Position [degrees*10]"),
          cex = 1,
        side = 1,#side 1 = bottom
        line = 2.5)
    mtext(text = "Frequency",
          cex = 1,
        side = 2, #side 2 = left
        line = 2)      
  }  
```

<!-- Superimposed histograms -->

```{r SupPosHistograms, eval=(NofGroups==2), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}    

if('yt' %in% sequence$type || 'sw' %in% sequence$type)                  #for yt or sw experiments, plot fly data
      {
       cat("\n## Superimposed Histograms\n")
       print(ggplot(supHistos, aes(x = fly)) + 
            geom_rect(aes(xmin = -Inf, xmax = 0, ymin = -Inf, ymax = Inf), fill=("lightgrey")) +
            geom_histogram(aes(fill = group, y=..density..), position = "identity", alpha=0.4, binwidth=3) +
            labs(x="Fly Behavior [arb. units]", y="rel. frequency") + 
            scale_x_continuous(limits=maxfly, breaks = c(-200, -100, 0, 100, 200), expand = c(0,0)) +
            scale_y_continuous(expand = c(0,0)) +
            ggtitle("Superimposed Fly Behavior Histogram") +
            scale_fill_manual(values = c("#E7B800", "#00AFBB")) +
            theme_light() +
            theme(panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank()) +
            annotate("text", -Inf, Inf, label = "punished torque domain", hjust = -0.2, vjust = 1.3)+
            annotate("text", Inf, Inf, label = "unpunished torque domain", hjust =1.1, vjust = 1.3))
  
      } else if ('fs' %in% sequence$type || 'color' %in% sequence$type) #for fs or color experiments, plot folded arena position data
      {
       cat("\n## Superimposed Histograms\n")
       print(ggplot(supHistos, aes(x = a_pos)) + 
            geom_rect(aes(xmin = -Inf, xmax = 45, ymin = -Inf, ymax = Inf), fill=("lightgrey")) +
            geom_histogram(aes(fill = group, y=..density..), position = "identity", alpha=0.4, binwidth=1) +
            labs(x="Arena Position [degrees]", y="rel. frequency") + 
            scale_x_continuous(breaks = c(0, 45, 90), expand = c(0,0)) +
            scale_y_continuous(expand = c(0,0)) +
            ggtitle("Superimposed Position Histogram") +
            scale_fill_manual(values = c("#E7B800", "#00AFBB")) +
            theme_light() +
            theme(panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank()) +
            annotate("text", -Inf, Inf, label = "'hot' hemi-quadrant", hjust = -0.6, vjust = 1.3)+
            annotate("text", Inf, Inf, label = "'cold' hemi-quadrant", hjust =1.5, vjust = 1.3))
      }
```

<!-- Computing optomotor data if they are present -->

`r if (om | beforeafter) '# Optomotor evaluations'`
`r if (om) '## Optomotor traces (right/left)'`

```{r Optomotor, eval=om, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 10, comment=NA, results='asis'}

plotOMtracesMean(grouped.OMdata) #call function to plot OM traces averaged over all flies
```

`r if (beforeafter) '## Optomotor traces (right/left) at start of experiment'`

```{r OM_BeforeAfter, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 10, comment=NA, results='asis'}

plotOMtracesMean(grouped.OMdataBefore) #call function to plot OM traces at start of experiment averaged over all flies
  
cat(paste("\n\n## Optomotor traces (right/left) at end of experiment\n\n"))

plotOMtracesMean(grouped.OMdataAfter) #call function to plot OM traces at end of experiment averaged over all flies
```

`r if (om | beforeafter) '## Optomotor Parameter Analysis'`

```{r OMparams, eval=om, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 12, comment=NA, results='asis'}

####### Do not separate optomotor parameters at all: exclusively optomotor experiments only, no before/after ##########


plotOMparams=ldply(grouped.OMparams, data.frame)    #move the dataframes from each group into a single dataframe
OMvariables = head(names(plotOMparams),-1)
OMtitles = c("Optomotor Magnitude", "Optomotor Slope", "Asymmetry Index Magn.", "Asymmetry Index Slope")

#for one group or more than three groups without statistics
if(NofGroups==1|NofGroups>3)
  {
        for (v in 1:4) {
           cat(paste("\n\n## ", OMtitles[v], "\n\n", sep = ""))
           print(ggplot(plotOMparams, aes(group, plotOMparams[[OMvariables[v]]])) +
              geom_boxplot(fill = boxcolors, notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = plotOMparams, aes(group, plotOMparams[[OMvariables[v]]]), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
              theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
              samplesizes.annotate(boxes, samplesizes))
        }
}

#for two groups with statistics
if(NofGroups==2)
  {
        for (v in 1:4) {
          cat(paste("\n\n## ", OMtitles[v], "\n\n", sep = ""))
          plots.2test<-plotOMParamBox(v, plotOMparams, samplesizes, OMvariables, OMtitles) #call function to plot box/whisker diagram and calculate statistics
          grid.arrange(grobs = plots.2test, ncol=2)
        }
}

#for three groups with statistics
if(NofGroups==3 & length(unique(groupdescriptions))==2){
  OMparamsSingleton <- na.omit(grouped.OMparams[[grep(singleton[1], grouped.OMparams)]])
  OMparamsDoubleton1 <- na.omit(grouped.OMparams[[grep(doubleton[1], grouped.OMparams)[1]]])
  OMparamsDoubleton2 <- na.omit(grouped.OMparams[[grep(doubleton[1], grouped.OMparams)[2]]])
  gname<-t(as.data.frame(groupnames))
  PIname<-c(unique(OMparamsSingleton$group), unique(OMparamsDoubleton1$group),unique(OMparamsDoubleton2$group))
  
  
  for (v in 1:4) {
    cat(paste("\n\n## ", OMtitles[v], "\n\n", sep = ""))
    test1 = statistical_test(OMparamsSingleton[[v]], OMparamsDoubleton1[[v]])
    test2 = statistical_test(OMparamsSingleton[[v]], OMparamsDoubleton2[[v]])
    results.test<-data.frame(cbind(test1, test2))
    colnames(results.test)<-c(paste(PIname[1], PIname[2], sep="\n"),paste(PIname[1], PIname[3], sep="\n"))  
    rownames(results.test)<-c("Significance level",
                               "MW U-Test, W",
                               "U-Test p-value", 
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")
    # plot three parameters with asterisks
    plotOMparams$group <- as.character(plotOMparams$group)
    plotOMparams$group <- factor(plotOMparams$group, levels=unique(plotOMparams$group))
      plots.2test<-ggplot(plotOMparams, aes(group, plotOMparams[[OMvariables[v]]])) +
      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
      geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
      geom_jitter(data = plotOMparams, aes(group, plotOMparams[[OMvariables[v]]]),
                shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black",fill=NA),
                legend.position = "top",legend.title = element_blank()) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+
      ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
      geom_signif(comparisons = list(c(unique(OMparamsSingleton$group), unique(OMparamsDoubleton1$group))),
                map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                textsize=5, vjust=0.1) +
      geom_signif(comparisons = list(c(unique(OMparamsSingleton$group), unique(OMparamsDoubleton2$group))),
                map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                textsize=5, vjust=0.1,margin_top=0.15) +
      samplesizes.annotate(boxes, samplesizes)
    #add table with results and plot
    plots.2utest<-tableGrob(results.test)
    grid.arrange(plots.2test,plots.2utest, nrow = 1)
    
  }
} else {
  OMparams_1 <- na.omit(grouped.OMparams[[1]])
  OMparams_2 <- na.omit(grouped.OMparams[[2]])
  OMparams_3 <- na.omit(grouped.OMparams[[3]])
  gname<-t(as.data.frame(groupnames))
  PIname<-c(unique(OMparams_1$group), unique(OMparams_2$group), unique(OMparams_3$group))
  for (v in 1:4) {
    cat(paste("\n\n## ", OMtitles[v], "\n\n", sep = ""))
    test1 = statistical_test(OMparams_1[[v]], OMparams_2[[v]])
    test2 = statistical_test(OMparams_1[[v]], OMparams_3[[v]])
    test3 = statistical_test(OMparams_2[[v]], OMparams_3[[v]])
    results.test<-data.frame(cbind(test1, test2, test3))
    colnames(results.test)<-c(paste(PIname[1], PIname[2], sep="\n"), 
                               paste(PIname[1], PIname[3], sep="\n"),
                               paste(PIname[2], PIname[3], sep="\n"))  
    rownames(results.test)<-c("Significance level",
                               "MW U-Test, W",
                               "U-Test p-value", 
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")

    # plot three parameters with asterisks
  plotOMparams$group <- as.character(plotOMparams$group)
  plotOMparams$group <- factor(plotOMparams$group, levels=unique(plotOMparams$group))
      plots.2test<-ggplot(plotOMparams, aes(group, plotOMparams[[OMvariables[v]]])) +
      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
      geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
      geom_jitter(data = plotOMparams, aes(group, plotOMparams[[OMvariables[v]]]),
                shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black",fill=NA),
                legend.position = "top",legend.title = element_blank()) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+
      ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
      geom_signif(comparisons = list(c(unique(OMparams_1$group), unique(OMparams_2$group))),
                map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                textsize=5, vjust=0.1, margin_top = 0.1) +
      geom_signif(comparisons = list(c(unique(OMparams_1$group), unique(OMparams_3$group))),
                map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                textsize=5, vjust=0.1,margin_top=0.2) +
      geom_signif(comparisons = list(c(unique(OMparams_2$group), unique(OMparams_3$group))),
                map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                textsize=5, vjust=0.1,margin_top=0.1) +
      samplesizes.annotate(boxes, samplesizes)
    #add table with results and plot
    plots.2utest<-tableGrob(results.test)
    grid.arrange(plots.2test,plots.2utest, nrow = 1)
    
    
    }
}
```

```{r OMparamsBefore, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 12, comment=NA, results='asis'}

######### Separate optomotor evaluations: optomotor parameters at the start of the experiment ###############

plotOMparamsBefore=ldply(grouped.OMparamsBefore, data.frame)    #move the dataframes from each group into a single dataframe
OMvariables = head(names(plotOMparamsBefore),-1)
OMtitles = c("Optomotor Magnitude", "Optomotor Slope", "Asymmetry Index Magn.", "Asymmetry Index Slope")

#for one group without statistics
if(NofGroups==1 | NofGroups > 3)
  {
        for (v in 1:4) {
           cat(paste("\n\n## ", OMtitles[v], " at start of experiment\n\n", sep = ""))
           print(ggplot(plotOMparamsBefore, aes(group, plotOMparamsBefore[[OMvariables[v]]])) +
              geom_boxplot(fill = boxcolors, notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = plotOMparamsBefore, aes(group, plotOMparamsBefore[[OMvariables[v]]]), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
              theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
              samplesizes.annotate(boxes, samplesizes))
        }
}

#for two groups with statistics
if(NofGroups==2)
  {
        for (v in 1:4) {
          cat(paste("\n\n## ", OMtitles[v], " at start of experiment\n\n", sep = ""))
            plots.2test<-plotOMParamBox(v, plotOMparamsBefore, samplesizes, OMvariables, OMtitles) #call function to plot box/whisker diagram and calculate statistics
          grid.arrange(grobs = plots.2test, ncol=2)
        }
}

#for three groups with statistics
if(NofGroups==3){
  if(length(unique(groupdescriptions))==2) { #if there are two identical group descriptions
  OMparamsBeforeSingleton <- na.omit(grouped.OMparamsBefore[[grep(singleton[1], grouped.OMparamsBefore)]])
  OMparamsBeforeDoubleton1 <- na.omit(grouped.OMparamsBefore[[grep(doubleton[1], grouped.OMparamsBefore)[1]]])
  OMparamsBeforeDoubleton2 <- na.omit(grouped.OMparamsBefore[[grep(doubleton[1], grouped.OMparamsBefore)[2]]])
  PIname<-c(unique(OMparamsBeforeSingleton$group), unique(OMparamsBeforeDoubleton1$group),unique(OMparamsBeforeDoubleton2$group))
  
    for (v in 1:4) {
      cat(paste("\n\n## ", OMtitles[v], " at start of experiment\n\n", sep = ""))
      TestxCont1 = statistical_test(OMparamsBeforeSingleton[[v]], OMparamsBeforeDoubleton1[[v]])
      TestxCont2 = statistical_test(OMparamsBeforeSingleton[[v]], OMparamsBeforeDoubleton2[[v]])
      results.test<-data.frame(cbind(TestxCont1, TestxCont2))
      colnames(results.test)<-c(paste(PIname[1], PIname[2], sep="\n"),paste(PIname[1], PIname[3], sep="\n"))  
      rownames(results.test)<-c("Significance level",
                                 "MW U-Test, W",
                                 "U-Test p-value", 
                                 "Cohen's D",
                                 "stat. Power",
                                 "Bayes Factor",
                                 "Bayes Factor error",
                                 paste("FP risk, prior ",priorval[1]),
                                 paste("FP risk, prior ",priorval[2]),
                                 "Likelihood Ratio")
      plotOMparamsBefore$group <- as.character(plotOMparamsBefore$group)
      plotOMparamsBefore$group <- factor(plotOMparamsBefore$group, levels=unique(plotOMparamsBefore$group))
            plots.2test<-ggplot(plotOMparamsBefore, aes(group, plotOMparamsBefore[[OMvariables[v]]])) +
            geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
            geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
            geom_jitter(data = plotOMparamsBefore, aes(group, plotOMparamsBefore[[OMvariables[v]]]),
                      shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
            theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                      panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black",fill=NA), 
                      legend.position = "top",legend.title = element_blank()) +
            theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+
            ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
            geom_signif(comparisons = list(c(unique(OMparamsBeforeSingleton$group), unique(OMparamsBeforeDoubleton1$group))),
                      map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                      textsize=5, vjust=0.1) +
            geom_signif(comparisons = list(c(unique(OMparamsBeforeSingleton$group), unique(OMparamsBeforeDoubleton2$group))),
                      map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                      textsize=5, vjust=0.1, margin_top=0.15) +
            samplesizes.annotate(boxes, samplesizes)
          #add table with results and plot
          plots.2utest<-tableGrob(results.test)
          grid.arrange(plots.2test,plots.2utest, nrow = 1)
    } 
  } else { #if there are more than two group descriptions (what if there is only one?)
    OMparamsBefore_1 <- na.omit(grouped.OMparamsBefore[[1]])
    OMparamsBefore_2 <- na.omit(grouped.OMparamsBefore[[2]])
    OMparamsBefore_3 <- na.omit(grouped.OMparamsBefore[[3]])
    PIname<-c(unique(OMparamsBefore_1$group), unique(OMparamsBefore_2$group),unique(OMparamsBefore_3$group))
    for (v in 1:4) {
      TestxCont1 = statistical_test(OMparamsBefore_1[[v]], OMparamsBefore_2[[v]])
      TestxCont2 = statistical_test(OMparamsBefore_1[[v]], OMparamsBefore_3[[v]])
      TestxCont3 = statistical_test(OMparamsBefore_2[[v]], OMparamsBefore_3[[v]])
      results.test<-data.frame(cbind(TestxCont1, TestxCont2, TestxCont3))
      colnames(results.test)<-c(paste(PIname[1], PIname[2], sep="\n"), 
                                 paste(PIname[1], PIname[3], sep="\n"),
                                 paste(PIname[2], PIname[3], sep="\n"))  
      
      rownames(results.test)<-c("Significance level",
                                 "MW U-Test, W",
                                 "U-Test p-value", 
                                 "Cohen's D",
                                 "stat. Power",
                                 "Bayes Factor",
                                 "Bayes Factor error",
                                 paste("FP risk, prior ",priorval[1]),
                                 paste("FP risk, prior ",priorval[2]),
                                 "Likelihood Ratio")
      
      # plot three parameters with asterisks
      plotOMparamsBefore$group <- as.character(plotOMparamsBefore$group)
      plotOMparamsBefore$group <- factor(plotOMparamsBefore$group, levels=unique(plotOMparamsBefore$group))
            plots.2test<-ggplot(plotOMparamsBefore, aes(group, plotOMparamsBefore[[OMvariables[v]]])) +
            geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
            geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
            geom_jitter(data = plotOMparamsBefore, aes(group, plotOMparamsBefore[[OMvariables[v]]]),
                      shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
            theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                      panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black",fill=NA), 
                      legend.position = "top",legend.title = element_blank()) +
            theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+
            ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
            geom_signif(comparisons = list(c(unique(OMparamsBefore_1$group), unique(OMparamsBefore_2$group))),
                      map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                      textsize=5, vjust=0.1, margin_top=0.1) +
            geom_signif(comparisons = list(c(unique(OMparamsBefore_1$group), unique(OMparamsBefore_3$group))),
                      map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                      textsize=5, vjust=0.1,margin_top=0.2) +
            geom_signif(comparisons = list(c(unique(OMparamsBefore_2$group), unique(OMparamsBefore_3$group))),
                      map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                      textsize=5, vjust=0.1,margin_top=0.1) +
            samplesizes.annotate(boxes, samplesizes)
          #add table with results and plot
          plots.2utest<-tableGrob(results.test)
          grid.arrange(plots.2test,plots.2utest, nrow = 1)
    }
  }
}
```

```{r OMparamsAfter, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 12, comment=NA, results='asis'}

######### Separate optomotor evaluations: optomotor parameters at the end of the experiment ###############

plotOMparamsAfter=ldply(grouped.OMparamsAfter, data.frame)    #move the dataframes from each group into a single dataframe
OMvariables = head(names(plotOMparamsAfter),-1)
OMtitles = c("Optomotor Magnitude", "Optomotor Slope", "Asymmetry Index Magn.", "Asymmetry Index Slope")

#for one group without statistics
if(NofGroups==1 | NofGroups > 3)
  {
        for (v in 1:4) {
           cat(paste("\n\n## ", OMtitles[v], " at end of experiment\n\n", sep = ""))
           print(ggplot(plotOMparamsAfter, aes(group, plotOMparamsAfter[[OMvariables[v]]])) +
              geom_boxplot(fill = boxcolors, notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter(data = plotOMparamsAfter, aes(group, plotOMparamsAfter[[OMvariables[v]]]), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
              theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
              samplesizes.annotate(boxes, samplesizes))
        }
}

#for two groups with statistics
if(NofGroups==2)
  {
        for (v in 1:4) {
           cat(paste("\n\n## ", OMtitles[v], " at end of experiment\n\n", sep = ""))
            plots.2test<-plotOMParamBox(v, plotOMparamsAfter, samplesizes, OMvariables, OMtitles) #call function to plot box/whisker diagram and calculate statistics
          grid.arrange(grobs = plots.2test, ncol=2)
        } 
}

#for three groups with statistics
if(NofGroups==3){
  if(length(unique(groupdescriptions))==2) { #if there are two identical group descriptions
  OMparamsAfterSingleton <- na.omit(grouped.OMparamsAfter[[grep(singleton[1], grouped.OMparamsAfter)]])
  OMparamsAfterDoubleton1 <- na.omit(grouped.OMparamsAfter[[grep(doubleton[1], grouped.OMparamsAfter)[1]]])
  OMparamsAfterDoubleton2 <- na.omit(grouped.OMparamsAfter[[grep(doubleton[1], grouped.OMparamsAfter)[2]]])
  PIname<-c(unique(OMparamsAfterSingleton$group), unique(OMparamsAfterDoubleton1$group),unique(OMparamsAfterDoubleton2$group))
  
  for (v in 1:4) {
    cat(paste("\n\n## ", OMtitles[v], " at end of experiment\n\n", sep = ""))
    test1 = statistical_test(OMparamsAfterSingleton[[v]], OMparamsAfterDoubleton1[[v]])
    test2 = statistical_test(OMparamsAfterSingleton[[v]], OMparamsAfterDoubleton2[[v]])
    results.test <- data.frame(cbind(test1, test2))
    colnames(results.test) <- c(paste(PIname[1], PIname[2], sep="\n"),paste(PIname[1], PIname[3], sep="\n")) 
    rownames(results.test) <- c("Significance level",
                               "MW U-Test, W",
                               "U-Test p-value", 
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")
    # plot parameters with asterisks
  plotOMparamsAfter$group <- as.character(plotOMparamsAfter$group)
  plotOMparamsAfter$group <- factor(plotOMparamsAfter$group, levels=unique(plotOMparamsAfter$group))
    plots.2test<-ggplot(plotOMparamsAfter, aes(group, plotOMparamsAfter[[OMvariables[v]]])) +
      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
      geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
      geom_jitter(data = plotOMparamsAfter, aes(group, plotOMparamsAfter[[OMvariables[v]]]), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black",fill=NA),
                legend.position = "top",legend.title = element_blank()) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+
      ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
      geom_signif(comparisons = list(c(unique(OMparamsAfterSingleton$group), unique(OMparamsAfterDoubleton1$group))),
                map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                textsize=5, vjust=0.1) +
      geom_signif(comparisons = list(c(unique(OMparamsAfterSingleton$group), unique(OMparamsAfterDoubleton2$group))),
                map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                textsize=5, vjust=0.1,margin_top=0.15) +
      samplesizes.annotate(boxes, samplesizes)

    #add table with results and plot
    plots.2utest<-tableGrob(results.test)

    grid.arrange(plots.2test,plots.2utest, nrow = 1)
  }
      } else {
        OMparamsAfter_1 <- na.omit(grouped.OMparamsAfter[[1]])
        OMparamsAfter_2 <- na.omit(grouped.OMparamsAfter[[2]])
        OMparamsAfter_3 <- na.omit(grouped.OMparamsAfter[[3]])
        PIname<-c(unique(OMparamsBefore_1$group), unique(OMparamsBefore_2$group),unique(OMparamsBefore_3$group))
        for (v in 1:4) {
          cat(paste("\n\n## ", OMtitles[v], " at end of experiment\n\n", sep = ""))
          test1 = statistical_test(OMparamsAfter_1[[v]], OMparamsAfter_2[[v]])
          test2 = statistical_test(OMparamsAfter_1[[v]], OMparamsAfter_3[[v]])
          test3 = statistical_test(OMparamsAfter_2[[v]], OMparamsAfter_3[[v]])
          results.test<-data.frame(cbind(test1, test2, test3))
          colnames(results.test)<-c(paste(PIname[1], PIname[2], sep="\n"), 
                                     paste(PIname[1], PIname[3], sep="\n"),
                                     paste(PIname[2], PIname[3], sep="\n"))  
          
          rownames(results.test)<-c("Significance level",
                                     "MW U-Test, W",
                                     "U-Test p-value", 
                                     "Cohen's D",
                                     "stat. Power",
                                     "Bayes Factor",
                                     "Bayes Factor error",
                                     paste("FP risk, prior ",priorval[1]),
                                     paste("FP risk, prior ",priorval[2]),
                                     "Likelihood Ratio")
      
      
          # plot parameters with asterisks
        plotOMparamsAfter$group <- as.character(plotOMparamsAfter$group)
        plotOMparamsAfter$group <- factor(plotOMparamsAfter$group, levels=unique(plotOMparamsAfter$group))
          plots.2test<-ggplot(plotOMparamsAfter, aes(group, plotOMparamsAfter[[OMvariables[v]]])) +
            geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
            geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
            geom_jitter(data = plotOMparamsAfter, aes(group, plotOMparamsAfter[[OMvariables[v]]]), position=position_jitter(0.3), shape=21, size=3, colour="black", fill="grey50", alpha=0.4) +
            theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                      panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black",fill=NA),
                      legend.position = "top",legend.title = element_blank()) +
            theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+
            ylab(paste(OMtitles[v], " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
            geom_signif(comparisons = list(c(unique(OMparamsAfter_1$group), unique(OMparamsAfter_2$group))),
                      map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                      textsize=5, vjust=0.1, margin_top=0.1) +
            geom_signif(comparisons = list(c(unique(OMparamsAfter_1$group), unique(OMparamsAfter_3$group))),
                      map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                      textsize=5, vjust=0.1, margin_top=0.2) +
            geom_signif(comparisons = list(c(unique(OMparamsAfter_2$group), unique(OMparamsAfter_3$group))),
                      map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                      textsize=5, vjust=0.1, margin_top=0.1) +
            samplesizes.annotate(boxes, samplesizes)
      
          #add table with results and plot
          plots.2utest<-tableGrob(results.test)
      
          grid.arrange(plots.2test,plots.2utest, nrow = 1)
      
        }
      }
}
```

# Fourier Spectrum Analysis

```{r spectra, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8}
spectemp <- do.call("rbind", grouped.spectra) #create single data.frame with grouping variable from list of groups
print(ggplot(spectemp, aes(x=freq, y=mean, group = group)) + 
        geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd, fill = group), alpha=0.5) +
        scale_fill_manual(values = boxcolors) +
        geom_line(aes(colour = group), size = 2) + 
        scale_color_manual(values = boxcolors) +
        scale_x_continuous(breaks = seq(0, 10, 2), limits = c(0, 10), expand=c(0,0)) +
        scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1), expand=c(0,0)) +
        ggtitle("Powerspectra") +
        guides(colour = guide_legend(override.aes = list(size=3))) +
        theme_light(base_size = 16) + theme(legend.justification=c(1,0),
                                            legend.position=c(0.94,0.60), 
                                            legend.key.size = unit(2, 'lines'),
                                            legend.key = element_rect(size = 6),
                                            legend.box.background = element_rect(fill="white"),
                                            legend.box.margin = margin(4, 4, 4, 4),
                                            legend.text=element_text(size=14), 
                                            panel.grid.major.y = element_blank(),
                                            panel.grid.minor = element_blank(),
                                            panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
        theme(axis.text.y = element_text(size=12))+ ylab("mean rel. Power") + xlab("Frequency [Hz]"))
```

<!-- Compute dwelling times -->

```{r Mean dwelling, eval=Dwell, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 8, comment=NA, results='asis'}

cat("\n# Dwelling Times\n")

dwellmeanplots = list() #create a list to store all the plots

for(x in 1:NofGroups){
  grouped.dwell[[x]]$punished = -grouped.dwell[[x]]$punished #invert the punished values to make the bars go downwards
  dwellmeans[[x]] = reshape2::melt(grouped.dwell[[x]])       #load each group of data into a dataframe
  colnames(dwellmeans[[x]])=c("period","value","Outcome")
  dwellmeanplots[[x]] <-   ggplot(dwellmeans[[x]], aes(as.factor(period), value, fill = Outcome)) +
  stat_summary(geom = "bar", fun = mean, col="black", width = 0.7)+
   stat_summary(geom = "errorbar", fun.data = mean_se, width = 0.3)+
  geom_hline(yintercept = 0, colour = "#887000", size = 1.2)+
  geom_jitter(pch=21, colour="Black", size=2.3, width = 0.25)+
  ggtitle(paste(dataset.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x]))+
  theme_light(base_size = 16) +
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank()
        ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA))+
  theme(axis.text.y = element_text(size=18), legend.position = "none")+
  ylab("mean dwelling [sec]")+
  labs(fill = "Outcome") +
  xlab("Experiment Sequence")+
  scale_fill_manual(values=c("red1", "steelblue4"))+
  scale_color_manual(values=c("firebrick4", "steelblue3"))+
  theme(panel.grid.major = element_line(colour = "#808080")) + 
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = 0, 
           alpha = .3)+
  ylim(dwellrange) +
  guides(fill = FALSE, size = FALSE)
}
 grid.arrange(grobs = dwellmeanplots)
```

```{r PIbar, eval=PIs_present, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 8, comment=NA, results='asis'}
cat("\n# Performance Indices\n \n## Performance Index bar plot with SEM:\n")

PIplots <- list()
for(x in 1:NofGroups)
  {
    PIprofile <- grouped.PIcombined[[x]] #get PIs (categories not used)

    # plot graph
     PIplots[[x]] <- ggplot(PIprofile, aes(x=period, y=PIs)) + 
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              stat_summary(geom = "bar", fun.y = mean, position = "dodge", fill=as.vector(na.omit(sequence$color)), colour="black", width=1) +
              stat_summary(geom = "errorbar", fun.data = mean_se, position = "dodge", width=0, size=2) +
              ggtitle(paste(dataset.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x])) +
              scale_y_continuous(breaks = seq(-1, 1, .2)) +
              theme_light(base_size = 16) + 
              theme(panel.grid.major.x = element_blank(),panel.grid.minor = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ 
              ylab("PI [rel. units]") + 
              xlab("Experiment Sequence") +
              theme(aspect.ratio=aspect_ratio)
  }
grid.arrange(grobs = PIplots, nrow=NofGroups)
```

```{r PIbarsub, eval=PIs_present, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 8, comment=NA, results='asis'}
cat("\n## Performance Index bar plot - preference subtracted:\n")

for(x in 1:NofGroups)
  {
    PIprofile <- grouped.PIcombined[[x]] #get PIs (categories not used)
    avgPretest = mean(subset(pretestPIs, group==groupnames[x])$category, na.rm=TRUE) #average pretest value
    PIprofile$PIs=PIprofile$PIs-avgPretest

    # plot graph
     PIplots[[x]] <- ggplot(PIprofile, aes(x=period, y=PIs)) + 
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              stat_summary(geom = "bar", fun.y = mean, position = "dodge", fill=as.vector(na.omit(sequence$color)), colour="black", width=1) +
              stat_summary(geom = "errorbar", fun.data = mean_se, position = "dodge", width=0, size=2) +
              ggtitle(paste(dataset.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x])) +
              scale_y_continuous(breaks = seq(-1, 1, .2)) +
              theme_light(base_size = 16) + 
              theme(panel.grid.major.x = element_blank(),panel.grid.minor = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ 
              ylab("PI [rel. units]") + 
              xlab("Experiment Sequence") +
              theme(aspect.ratio=aspect_ratio)
  }
grid.arrange(grobs = PIplots, nrow=NofGroups)
```

```{r BoxWithNotch, eval=PIs_present, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 10, comment=NA, results='asis'}
cat("\n## Performance Index box&dotplot with notches:\n")

for(x in 1:NofGroups)
  {
    PIprofile <- grouped.PIcombined[[x]] #get PIs with categories
    PIprofile$flyname = rep(flynames[,x][!is.na(flynames[,x])])

    #plot graph
    PIplots[[x]] <- ggplot(PIprofile, aes(period, PIs)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_boxplot(fill = as.vector(na.omit(sequence$color)), notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter_interactive(data = PIprofile, aes(period, PIs, fill=category) ,tooltip = PIprofile$flyname, data_id = PIprofile$flyname , col = "grey", pch=21, size=3.3, width = 0.25, alpha=0.7)+
              ggtitle(paste(dataset.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x])) +
              scale_y_continuous(breaks = seq(-1, 1, .4)) +
              theme_light(base_size = 16) + 
              theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ 
              ylab("PI [rel. units]")+ 
              xlab("Experiment Sequence") + 
              theme(aspect.ratio=aspect_ratio) +
              scale_fill_discrete(name = "Heat on:") #legend title for categories 

    }  
girafe(ggobj = plot_grid(plotlist=PIplots, ncol = 1),options = list(opts_selection(type = "single",css = "fill:orange;stroke:gray;r:4pt;", only_shiny = FALSE)), width_svg = 4+(length(unique(PIprofile$period))), height_svg = 5*NofGroups)
```


```{r BoxNoNotch, eval=PIs_present, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 10, comment=NA, results='asis'}
cat("\n## Performance Index box&dotplot without notches:\n")

for(x in 1:NofGroups)
  {
    PIprofile <- grouped.PIcombined[[x]] #get PIs with categories
    PIprofile$flyname = rep(flynames[,x][!is.na(flynames[,x])])

    #plot graph
    PIplots[[x]] <- ggplot(PIprofile, aes(period, PIs)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_boxplot(fill = as.vector(na.omit(sequence$color)), notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
              geom_jitter_interactive(data = PIprofile, aes(period, PIs, fill=category) ,tooltip = PIprofile$flyname, data_id = PIprofile$flyname , col = "grey", pch=21, size=3.3, width = 0.25, alpha=0.7)+
              ggtitle(paste(dataset.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x])) +
              scale_y_continuous(breaks = seq(-1, 1, .4)) +
              theme_light(base_size = 16) + 
              theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ 
              ylab("PI [rel. units]")+ 
              xlab("Experiment Sequence") + 
              theme(aspect.ratio=aspect_ratio) +
              scale_fill_discrete(name = "Heat on:") #legend title for categories 

    }        
girafe(ggobj = plot_grid(plotlist=PIplots, ncol = 1),options = list(opts_selection(type = "single",css = "fill:orange;stroke:gray;r:4pt;", only_shiny = FALSE)), width_svg = 4+(length(unique(PIprofile$period))), height_svg = 5*NofGroups)
```


```{r Violin, eval=PIs_present, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = len, fig.width = 8, comment=NA, results='asis'}
cat("\n## Performance Index Violin Plot:\n")

for(x in 1:NofGroups)
  {
  PIprofile <- grouped.PIcombined[[x]] #get PIs (categories not used)

    PIplots[[x]] <- ggplot(PIprofile, aes(period, PIs)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_violin(width = 1.1) +
              geom_boxplot(fill = as.vector(na.omit(sequence$color)), width = 0.1, outlier.color="darkred") +
              ggtitle(paste(dataset.data[["resources"]][[x]][["title"]], ", N=",samplesizes[x])) +
              scale_y_continuous(breaks = seq(-1, 1, .4)) +
              theme_light(base_size = 16) + 
              theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank() ,panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.y = element_text(size=18))+ 
              ylab("PI [rel. units]")+ 
              xlab("Experiment Sequence") + 
              theme(aspect.ratio=aspect_ratio)
  }
grid.arrange(grobs = PIplots, nrow=NofGroups)
```

```{r OMPI_correlation, eval=(PIs_present & beforeafter & any(sequence$type=="yt") & NofGroups==2), echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.height = 9, fig.width = 9, comment=NA, results='asis'}
cat("\n# Correlation between Performance Index and Optomotor Asymmetry\n")

#WARNING! This code expects the dataset to be divided into two groups: one punished on right torque, the other on left torque  
#WARNING! This code still needs to be generalized such that it works properly with any kind of group setup.

# change sign of asymmetry index OM for flies punished on the right, as they should shift negative, but we need positive values to indicate learning
# not all experiments will be set up like this, so let's make this step conditional (would be nice not to have to do this)
if("right" %in% plotOMparamsBefore$group){ 
plotOMparamsBefore[plotOMparamsBefore$group=="right",]$AI.OM.=-plotOMparamsBefore[plotOMparamsBefore$group=="right",]$AI.OM.
plotOMparamsAfter[plotOMparamsBefore$group=="right",]$AI.OM.=-plotOMparamsAfter[plotOMparamsBefore$group=="right",]$AI.OM.
}

#grab optomotor asymmetry values and PIs and put them in a dataframe for correlation analysis

OMPIcorr <- data.frame(plotOMparamsBefore$AI.OM., pretestPIs$category, plotOMparamsAfter$AI.OM., postPIs$category, postPIs$group)

CorrPlots <- list()
CorrPlots[[1]] <- ggplot(OMPIcorr, aes(pretestPIs.category, plotOMparamsBefore.AI.OM.)) +           #plot the correlation between PIs and OM asymmetry before training
              geom_point(aes(colour = postPIs.group, shape = postPIs.group), size=4) +
              scale_shape_manual(values = c("◄","►")) + #shape of the points
              scale_color_manual(values = boxcolors) + #color of the points
              stat_poly_line() +
              stat_poly_eq(label.y=1, use_label(c("eq", "adj.R2", "f", "p", "n"))) +
              scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-1,1)) +
              scale_x_continuous(breaks = seq(-1, 1, .2), limits = c(-1,1)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 0.5) +
              theme_light(base_size = 16) + 
              theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank()) +
              theme(panel.border = element_blank(),
                    axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
                    axis.line.y = element_line(size = 0.5, linetype = "solid", colour = "black")) +
              theme(axis.text = element_text(size=12))+ 
              theme(axis.text = element_text(size=12))+ 
              ylab("OM Asymmetry [rel. units]")+ 
              xlab("Torque preference [rel. units]") + 
              theme(legend.position = "none") +  
              theme(aspect.ratio=1/1.4)

mOMPIbefore=subset(melt(OMPIcorr), variable %in% c("plotOMparamsBefore.AI.OM.", "pretestPIs.category")) # melt dataframes with values before training for rainclodplots
levels(mOMPIbefore$postPIs.group)[match("right",levels(mOMPIbefore$postPIs.group))] <- "►" #replace group description
levels(mOMPIbefore$postPIs.group)[match("left",levels(mOMPIbefore$postPIs.group))] <- "◄" #replace group description

####statistics and raincloudplots of indices before training###   education[which(education$Region == 2)
#statistics
  wilcoxon<-numeric() 
  wilcoxon[1] = signif(wilcox.test(mOMPIbefore[which(mOMPIbefore$variable == "plotOMparamsBefore.AI.OM."),3])$p.value, 3) #test against zero
  wilcoxon[2] = signif(wilcox.test(mOMPIbefore[which(mOMPIbefore$variable == "pretestPIs.category"),3])$p.value, 3) #test against zero

#raincloudplots
CorrPlots[[2]] <- ggplot(mOMPIbefore, aes(variable, value, fill=variable, color=variable)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_rain(point.args = list(size = 3,
                                          shape=as.character(mOMPIbefore$postPIs.group),
                                          alpha=as.integer(as.factor(mOMPIbefore$postPIs.group))/max(as.integer(as.factor(mOMPIbefore$postPIs.group)))),
                      point.args.pos = list(position = ggpp::position_jitternudge(width = 0.1, x = -0.22, nudge.from = "jittered")),
                      boxplot.args = list(fill="white", color = "black", outlier.shape = NA, size=1.1),
                      boxplot.args.pos = list(width = 0.12),
                      violin.args = list(color = NA, alpha = .8),
                      violin.args.pos = list(side = "r", width = 1)) +
              stat_summary(fun.y = mean, color = "darkgrey", geom = "errorbar", aes(ymax = ..y.., ymin = ..y..), width = 0.2, size = 2.1)+
              stat_summary(fun.y=median, color="black", geom = "errorbar", aes(ymax = ..y.., ymin = ..y..), width = 0.2, size = 2.1)+
              scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-1,1)) +
              scale_fill_manual(values = boxcolors) + #color of the violin plot
              scale_color_manual(values = boxcolors) + #color of the points
              guides(fill = 'none', color = 'none')+ # remove legends
              theme_light(base_size = 16) + 
              theme(panel.grid.minor = element_blank(), 
                    panel.grid.major.x = element_blank(), 
                    axis.title.x=element_blank(), 
                    panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.x = element_text(size=10), axis.text.y = element_text(size=10)) + ylab(paste("Indices [rel. units]"))+
              scale_x_discrete(labels=c("optomotor", "torque")) +
              samplesizes.annotate(boxes, samplesizes) +
              wilcox.annotate(boxes, wilcoxon) +
              theme(aspect.ratio=2/1.2)

CorrPlots[[3]] <- ggplot(OMPIcorr, aes(postPIs.category, plotOMparamsAfter.AI.OM.)) +          #plot the correlation between PIs and OM asymmetry after training
              geom_point(aes(colour = postPIs.group, shape = postPIs.group), size=4) +
              scale_shape_manual(values = c("◄","►")) + #shape of the points
              scale_color_manual(values = boxcolors) + #color of the points
              stat_poly_line() +
              stat_poly_eq(label.y=1, use_label(c("eq", "adj.R2", "f", "p", "n"))) +
              scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-1,1)) +
              scale_x_continuous(breaks = seq(-1, 1, .2), limits = c(-1,1)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 0.5) +
              theme_light(base_size = 16) + 
              theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank()) +
              theme(panel.border = element_blank(),
                    axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
                    axis.line.y = element_line(size = 0.5, linetype = "solid", colour = "black")) +
              theme(axis.text = element_text(size=12))+ 
              ylab("OM Asymmetry [rel. units]")+ 
              xlab("Torque preference [rel. units]") + 
              theme(legend.position = "none") +
              theme(aspect.ratio=1/1.4)

mOMPIafter=subset(melt(OMPIcorr), variable %in% c("plotOMparamsAfter.AI.OM.", "postPIs.category"))  # melt dataframes with values after training for rainclodplots
levels(mOMPIafter$postPIs.group)[match("right",levels(mOMPIafter$postPIs.group))] <- "►" #replace group description
levels(mOMPIafter$postPIs.group)[match("left",levels(mOMPIafter$postPIs.group))] <- "◄" #replace group description

####statistics and raincloudplots of indices before training###   education[which(education$Region == 2)
#statistics
wilcoxon<-numeric() 
wilcoxon[1] = signif(wilcox.test(mOMPIafter[which(mOMPIafter$variable == "plotOMparamsAfter.AI.OM."),3])$p.value, 3) #test against zero
wilcoxon[2] = signif(wilcox.test(mOMPIafter[which(mOMPIafter$variable == "postPIs.category"),3])$p.value, 3) #test against zero

#raincloudplots
CorrPlots[[4]] <- ggplot(mOMPIafter, aes(variable, value, fill=variable, color=variable)) +
              geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
              geom_rain(point.args = list(size = 3,
                                          shape=as.character(mOMPIbefore$postPIs.group),
                                          alpha=as.integer(as.factor(mOMPIbefore$postPIs.group))/max(as.integer(as.factor(mOMPIbefore$postPIs.group)))),
                      point.args.pos = list(position = ggpp::position_jitternudge(width = 0.1, x = -0.22, nudge.from = "jittered")),
                      boxplot.args = list(fill="white", color = "black", outlier.shape = NA, size=1.1),
                      boxplot.args.pos = list(width = 0.12),
                      violin.args = list(color = NA, alpha = .8),
                      violin.args.pos = list(side = "r", width = 1)) +
              stat_summary(fun.y = mean, color = "darkgrey", geom = "errorbar", aes(ymax = ..y.., ymin = ..y..), width = 0.2, size = 2.1)+
              stat_summary(fun.y=median, color="black", geom = "errorbar", aes(ymax = ..y.., ymin = ..y..), width = 0.2, size = 2.1)+
              scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-1,1)) +
              scale_fill_manual(values = boxcolors) + #color of the violin plot
              scale_color_manual(values = boxcolors) + #color of the points
              guides(fill = 'none', color = 'none')+ # remove legends
              theme_light(base_size = 16) + 
              theme(panel.grid.minor = element_blank(), 
                    panel.grid.major.x = element_blank(), 
                    axis.title.x=element_blank(), 
                    panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA)) +
              theme(axis.text.x = element_text(size=10), axis.text.y = element_text(size=10)) + ylab(paste("Indices [rel. units]"))+
              scale_x_discrete(labels=c("optomotor", "torque"))+
              samplesizes.annotate(boxes, samplesizes) +
              wilcox.annotate(boxes, wilcoxon) +
              theme(aspect.ratio=2/1.2)

grid.arrange(grobs = CorrPlots, nrow=2, widths=2:1)


# change sign of asymmetry index OM back to original, just to be sure
if("right" %in% plotOMparamsBefore$group){
plotOMparamsBefore[plotOMparamsBefore$group=="right",]$AI.OM.=-plotOMparamsBefore[plotOMparamsBefore$group=="right",]$AI.OM.
plotOMparamsAfter[plotOMparamsBefore$group=="right",]$AI.OM.=-plotOMparamsAfter[plotOMparamsBefore$group=="right",]$AI.OM.
}
```


```{r Wilcoxon, eval=wil, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.height = 7, fig.width = 6, comment=NA, results='asis'}
cat("\n# Learning Score Statistics\n## Statistical tests of single groups against zero\n")
  
  wilcoxon<-numeric()  
  for(x in 1:NofGroups){wilcoxon[x] = signif(wilcox.test(PIstat[[x]])$p.value, 3)} #test all groups against zero
  #compute Bayes Factor for single group 
  if(NofGroups==1){
    results.bayes=extractBF(ttestBF(na.omit(PIstat[[1]])))
    results.bayes <- results.bayes[-c(3,4)] # drop the date and code columns
    row.names(results.bayes) <- groupnames #group name as row name
    results.bayes <- signif(results.bayes, digits=3) # reduce results to 3 significant digits
    } else { #compute Bayes Factors for several groups
          results.bayes<-list()
          for(x in 1:NofGroups){results.bayes[[x]]=extractBF(ttestBF(na.omit(PIstat[[x]])))} #extract BayesFactors for all groups
          results.bayes<-do.call("rbind", results.bayes) #fuse all Bayes results into one dataframe
          results.bayes <- results.bayes[-c(3,4)]# drop the date and code columns
          row.names(results.bayes) <- groupnames #group name as row name
          results.bayes <- signif(results.bayes, digits=3) # reduce results to 3 significant digits
    }

#prepare Grob with Bayes results table
    plots.singles<-list(tableGrob(results.bayes))
    
# plot PI box plot test against zero
  plots.singles[[2]]<-ggplot(PIstatCombined, aes(group, PIs)) +
    geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
    geom_boxplot(fill = boxcolors, notch = FALSE, outlier.color=NA, width=0.8, size=0.6) +
    geom_jitter(data=PIstatCombined, aes(group, PIs, fill=category), position=position_jitter(0.3), shape=21, size=3, alpha=0.5) +
    scale_y_continuous(breaks = seq(-1, 1, .2)) +
    theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), axis.title.x=element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA), legend.position = "bottom", legend.direction = "horizontal") +
    scale_fill_discrete(name = "Heat on:")+ #legend title for categories
    theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18)) + ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ theme(aspect.ratio=3/NofGroups)+
    samplesizes.annotate(boxes, samplesizes) +
    wilcox.annotate(boxes, wilcoxon)
  
#plots Bayes table and boxplot  
    grid.arrange(grobs = plots.singles, ncol=1, nrow=2, heights=c(0.2,1))
```

```{r WilcoxonRaincloud, eval=wil, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, fig.align = "center", fig.height=7, comment=NA, results='asis'}
cat("\n## Statistical tests of single groups against zero - raincloudplots\n")
  
  wilcoxon<-numeric()  
  for(x in 1:NofGroups){wilcoxon[x] = signif(wilcox.test(PIstat[[x]])$p.value, 3)} #test all groups against zero
  #compute Bayes Factor for single group 
  if(NofGroups==1){
    results.bayes=extractBF(ttestBF(na.omit(PIstat[[1]])))
    results.bayes <- results.bayes[-c(3,4)] # drop the date and code columns
    row.names(results.bayes) <- groupnames #group name as row name
    results.bayes <- signif(results.bayes, digits=3) # reduce results to 3 significant digits
    } else { #compute Bayes Factors for several groups
          results.bayes<-list()
          for(x in 1:NofGroups){results.bayes[[x]]=extractBF(ttestBF(na.omit(PIstat[[x]])))} #extract BayesFactors for all groups
          results.bayes<-do.call("rbind", results.bayes) #fuse all Bayes results into one dataframe
          results.bayes <- results.bayes[-c(3,4)]# drop the date and code columns
          row.names(results.bayes) <- groupnames #group name as row name
          results.bayes <- signif(results.bayes, digits=3) # reduce results to 3 significant digits
    }

#prepare Grob with Bayes results table
    plots.singles<-list(tableGrob(results.bayes))
    
# plot PI box plot test against zero
  plots.singles[[2]]<-ggplot(PIstatCombined, aes(group, PIs, fill=group, color=group)) +
    geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
    {if(typeof(HeatOn)=="double") #if the shapes are given as numbers (default), give them a black outline
    geom_rain(point.args = list(size = 5, shape=HeatOn, color = "black", alpha=as.integer(as.factor(PIstatCombined$category))/max(as.integer(as.factor(PIstatCombined$category)))),
              point.args.pos = list(position = ggpp::position_jitternudge(width = 0.1, x = -0.22, nudge.from = "jittered")),
              boxplot.args = list(fill="white", color = "black", outlier.shape = NA, size=1.1),
              boxplot.args.pos = list(width = 0.12),
              violin.args = list(color = NA, alpha = .8),
              violin.args.pos = list(side = "r", width = 1))} +
    {if(typeof(HeatOn)!="double") #if the shapes are assigned to specific categories, no black outlines
    geom_rain(point.args = list(size = 5, shape=HeatOn, alpha=as.integer(as.factor(PIstatCombined$category))/max(as.integer(as.factor(PIstatCombined$category)))),
              point.args.pos = list(position = ggpp::position_jitternudge(width = 0.1, x = -0.22, nudge.from = "jittered")),
              boxplot.args = list(fill="white", color = "black", outlier.shape = NA, size=1.1),
              boxplot.args.pos = list(width = 0.12),
              violin.args = list(color = NA, alpha = .8),
              violin.args.pos = list(side = "r", width = 1))} +
    stat_summary(fun.y = mean, color = "darkgrey", geom = "errorbar", aes(ymax = ..y.., ymin = ..y..), width = 0.2, size = 2.1)+
    stat_summary(fun.y=median, color="black", geom = "errorbar", aes(ymax = ..y.., ymin = ..y..), width = 0.2, size = 2.1)+
    scale_fill_manual(values = boxcolors) + #color of the violin plot
    scale_color_manual(values = boxcolors) + #color of the points
    scale_y_continuous(breaks = seq(-1, 1, .2)) +
    guides(fill = 'none', color = 'none')+ # remove legends
    theme_light(base_size = 16) + 
    theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), axis.title.x=element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA), legend.position = "bottom", legend.direction = "horizontal") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18)) + ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+
    theme(aspect.ratio=3/NofGroups)+
    samplesizes.annotate(boxes, samplesizes) +
    wilcox.annotate(boxes, wilcoxon)
  
#plots Bayes table and boxplot  
    grid.arrange(grobs = plots.singles, ncol=1, nrow=2, heights=c(0.2,1))
```

```{r Utest, eval=(PIs_present & twogroupstats & NofGroups==2), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height=8, comment=NA, results='asis'}
cat("\n## Statistical tests between two groups\n")

    utest = signif(wilcox.test(PIstat[[1]],PIstat[[2]])$p.value, 3) #compare the two groups with a U-test and collect p-value
    w.statistic = signif(wilcox.test(PIstat[[1]],PIstat[[2]])$statistic, 3)
    #compute effect size Cohen's D
    if(samplesizes[1]==samplesizes[2]){equalN=TRUE}else{equalN=FALSE}   #determine if the samplesizes are identical
    if(fligner.test(PIstatCombined$PIs,PIstatCombined$group)$p.value<0.05){hv=FALSE}else{hv=TRUE}       #test for homogeneity of variance and set hv TRUE/FALSE
    if(equalN & hv){hedges=FALSE}else{hedges=TRUE}                      #test if we need to apply Hedge's correction
    if(hedges){
      cohend = signif(cohen.d(PIstatCombined$PIs, PIstatCombined$group, hedges.correction = hedges)$estimate, 3) #use effsize package for Hedge's correction
    }else{
      cohend = signif((mean(na.omit(PIstat[[1]]))-mean(na.omit(PIstat[[2]])))/sqrt((sd(na.omit(PIstat[[1]]))^2+sd(na.omit(PIstat[[2]]))^2)/2), 3) #use simple formula if variances and sample sizes are identical
  }
    #calculate statistical power
    alt = dataset.data[["statistics"]][["two.groups"]][["power"]]
    power=signif(pwr.t2n.test(n1 = samplesizes[1], n2= samplesizes[2], d = cohend, alternative = alt, sig.level = signif[1])$power, 3)
    #calculate Bayes Factor
    bayesF=extractBF(ttestBF(na.omit(PIstat[[1]]), na.omit(PIstat[[2]])))
    #calculate FPR for priors set in dataset file#
    #run first prior  
      prior=priorval[1]
      out=calc.FPR(samplesizes,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz1=out[1]
    #run second prior  
      prior=priorval[2]
      out=calc.FPR(samplesizes,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz2=out[1]
    #Power and likelihood ratio: NB for two sided test, need 2*y0
      LR=out[5]/(2*out[3])        #lik ratio (Hi1/H0) =y1/2*y0

      #make tidy table of results
    results.utest<-data.frame(values=c(signif[1],
                                       w.statistic,
                                       utest,
                                       cohend,
                                       power,
                                       signif(bayesF$bf, 3),
                                       signif(bayesF$error, 3),
                                       signif(fpz1, 3),
                                       signif(fpz2, 3),
                                       signif(LR, 3)))
    rownames(results.utest)<-c("Significance level",
                               "MW U-Test, W",
                               "MW U-Test p",
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")

#prepare Grob with results table
  plots.2test<-list(tableGrob(results.utest))
        
# plot two PIs with asterisks
  plots.2test[[2]]<-ggplot(PIstatCombined, aes(group, PIs)) +
      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
      geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
      geom_jitter(data=PIstatCombined, aes(group, PIs, fill=category), position=position_jitter(0.3), shape=21, size=3, alpha=0.5) +
      scale_y_continuous(breaks = seq(-1, 1, .2)) +
      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), axis.title.x=element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA), legend.position = "bottom", legend.direction = "horizontal") +
      scale_fill_discrete(name = "Heat on:")+ #legend title for categories    
      theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18)) + 
      ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+
      theme(aspect.ratio=3/NofGroups)+
      geom_signif(comparisons = list(c(colnames(PIstat[1]), colnames(PIstat[2]))), 
                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                  textsize=4, vjust=0.1) +
      samplesizes.annotate(boxes, samplesizes)
  

  #add table with results and plot

  grid.arrange(grobs = plots.2test, ncol=1, nrow=2)

```

```{r UtestRain, eval=(PIs_present & twogroupstats & NofGroups==2), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height=8, comment=NA, results='asis'}
cat("\n## Statistical tests between two groups - Raincloudplots\n")

    utest = signif(wilcox.test(PIstat[[1]],PIstat[[2]])$p.value, 3) #compare the two groups with a U-test and collect p-value
    w.statistic = signif(wilcox.test(PIstat[[1]],PIstat[[2]])$statistic, 3)
    #compute effect size Cohen's D
    if(samplesizes[1]==samplesizes[2]){equalN=TRUE}else{equalN=FALSE}   #determine if the samplesizes are identical
    if(fligner.test(PIstatCombined$PIs,PIstatCombined$group)$p.value<0.05){hv=FALSE}else{hv=TRUE}       #test for homogeneity of variance and set hv TRUE/FALSE
    if(equalN & hv){hedges=FALSE}else{hedges=TRUE}                      #test if we need to apply Hedge's correction
    if(hedges){
      cohend = signif(cohen.d(PIstatCombined$PIs, PIstatCombined$group, hedges.correction = hedges)$estimate, 3) #use effsize package for Hedge's correction
    }else{
      cohend = signif((mean(na.omit(PIstat[[1]]))-mean(na.omit(PIstat[[2]])))/sqrt((sd(na.omit(PIstat[[1]]))^2+sd(na.omit(PIstat[[2]]))^2)/2), 3) #use simple formula if variances and sample sizes are identical
  }
    #calculate statistical power
    alt = dataset.data[["statistics"]][["two.groups"]][["power"]]
    power=signif(pwr.t2n.test(n1 = samplesizes[1], n2= samplesizes[2], d = cohend, alternative = alt, sig.level = signif[1])$power, 3)
    #calculate Bayes Factor
    bayesF=extractBF(ttestBF(na.omit(PIstat[[1]]), na.omit(PIstat[[2]])))
    #calculate FPR for priors set in dataset file#
    #run first prior  
      prior=priorval[1]
      out=calc.FPR(samplesizes,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz1=out[1]
    #run second prior  
      prior=priorval[2]
      out=calc.FPR(samplesizes,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz2=out[1]
    #Power and likelihood ratio: NB for two sided test, need 2*y0
      LR=out[5]/(2*out[3])        #lik ratio (Hi1/H0) =y1/2*y0

      #make tidy table of results
    results.utest<-data.frame(values=c(signif[1],
                                       w.statistic,
                                       utest,
                                       cohend,
                                       power,
                                       signif(bayesF$bf, 3),
                                       signif(bayesF$error, 3),
                                       signif(fpz1, 3),
                                       signif(fpz2, 3),
                                       signif(LR, 3)))
    rownames(results.utest)<-c("Significance level",
                               "MW U-Test, W",
                               "MW U-Test p",
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")

#prepare Grob with results table
  plots.2test<-list(tableGrob(results.utest))
        
# plot two PIs with asterisks
  plots.2test[[2]]<-ggplot(PIstatCombined, aes(group, PIs, fill=group, color=group)) +
    geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
    {if(typeof(HeatOn)=="double") #if the shapes are given as numbers (default), give them a black outline
    geom_rain(point.args = list(size = 5, shape=HeatOn, color = "black", alpha=as.integer(as.factor(PIstatCombined$category))/max(as.integer(as.factor(PIstatCombined$category)))),
              point.args.pos = list(position = ggpp::position_jitternudge(width = 0.1, x = -0.22, nudge.from = "jittered")),
              boxplot.args = list(fill="white", color = "black", outlier.shape = NA, size=1.1),
              boxplot.args.pos = list(width = 0.12),
              violin.args = list(color = NA, alpha = .8),
              violin.args.pos = list(side = "r", width = 1))} +
    {if(typeof(HeatOn)!="double") #if the shapes are assigned to specific categories, no black outlines
    geom_rain(point.args = list(size = 5, shape=HeatOn, alpha=as.integer(as.factor(PIstatCombined$category))/max(as.integer(as.factor(PIstatCombined$category)))),
              point.args.pos = list(position = ggpp::position_jitternudge(width = 0.1, x = -0.22, nudge.from = "jittered")),
              boxplot.args = list(fill="white", color = "black", outlier.shape = NA, size=1.1),
              boxplot.args.pos = list(width = 0.12),
              violin.args = list(color = NA, alpha = .8),
              violin.args.pos = list(side = "r", width = 1))} +
    stat_summary(fun.y = mean, color = "darkgrey", geom = "errorbar", aes(ymax = ..y.., ymin = ..y..), width = 0.2, size = 2.1)+
    stat_summary(fun.y=median, color="black", geom = "errorbar", aes(ymax = ..y.., ymin = ..y..), width = 0.2, size = 2.1)+
    scale_fill_manual(values = boxcolors) + #color of the violin plot
    scale_color_manual(values = boxcolors) + #color of the points
    scale_y_continuous(breaks = seq(-1, 1, .2)) +
    guides(fill = 'none', color = 'none')+ # remove legends
    theme_light(base_size = 16) + 
    theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), axis.title.x=element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA), legend.position = "bottom", legend.direction = "horizontal") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18)) + 
    ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+
    theme(aspect.ratio=3/NofGroups)+
    geom_signif(color="black",
      comparisons = list(c(colnames(PIstat[1]), colnames(PIstat[2]))), 
                map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                textsize=4, vjust=0.1) +
    samplesizes.annotate(boxes, samplesizes)
  

  #add table with results and plot

  grid.arrange(grobs = plots.2test, ncol=1, nrow=2)

```

```{r estimationstats, eval=(PIs_present & twogroupstats & NofGroups==2), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", comment=NA, results='asis'}
cat("\n## Estimation statistics\n")
unpaired_median_diff <- dabest(PIstatCombined, group, PIs, idx = groupnames, paired = FALSE) %>% median_diff() #create estimation results list
print(plot(unpaired_median_diff)) #plot results
```

```{r splitviolins, eval=(PIs_present & twogroupstats & NofGroups==2), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", comment=NA, results='asis'}
cat("\n## Split Violin Plot\n")

PIstatCombined$learningscore=dataset.data$statistics$`learning-score`$title #add x-axis value for split violin plots
print(ggplot(PIstatCombined, aes(learningscore, PIs, fill = group)) + scale_fill_manual(values=boxcolors) + geom_split_violin()) #plot spit violin plot

```

```{r raincloudplots, eval=(PIs_present & twogroupstats & NofGroups==2), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", comment=NA, results='asis'}
cat("\n## Raincloudplot pre/post\n")

print(raincloud_2x2_repmes(
  data = na.omit(rcp.PIs),
  colors = (rep(boxcolors, 2)),
  fills = (rep(boxcolors, 2)),
  size = 3,
  alpha = .7,
  spread_x_ticks = FALSE) +
  scale_x_continuous(breaks=c(1,2), labels=c("Pre", "Post"), limits=c(0, 3)) +
  xlab("Time") + 
  ylab("PI [rel. units]") +
  theme_classic())

```

```{r UtestG3, eval=(PIs_present & threegroupstats & NofGroups==3), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height=12, comment=NA, results='asis'}
cat("\n## Dyadic statistical tests with three groups\n")
#creating a list with PIs and condition in on list

if(NofGroups == 3) { #just to be extra-sure :-)

PItype <- list() 
for (x in 1:NofGroups){
  PItype[[x]] = melt(PIstat[[x]])
  PItype[[x]]$desc = dataset.data$resources[[x]]$description
  PItype[[x]]$name = dataset.data$resources[[x]]$name
}

if(length(unique(groupdescriptions))==2 & PIs_present) { #if two group descriptions are identical
   PItypeSingleton <- na.omit(PItype[[grep(singleton[1], PItype)]])
   PItypeDoubleton1 <- na.omit(PItype[[grep(doubleton[1], PItype)[1]]])
   PItypeDoubleton2 <- na.omit(PItype[[grep(doubleton[1], PItype)[2]]])
   PIname<-c(unique(PItypeSingleton$name), unique(PItypeDoubleton1$name), unique(PItypeDoubleton2$name))
   
   test1 = statistical_test(PItypeSingleton$value, PItypeDoubleton1$value)
   test2 = statistical_test(PItypeSingleton$value, PItypeDoubleton2$value)
   results.test <- data.frame(cbind(test1, test2))
   colnames(results.test) <- c(paste(PIname[1], PIname[2], sep="\n"),paste(PIname[1], PIname[3], sep="\n")) 
   rownames(results.test) <- c("Significance level",
                                  "MW U-Test, W",
                                  "U-Test p-value", 
                                  "Cohen's D",
                                  "stat. Power",
                                  "Bayes Factor",
                                  "Bayes Factor error",
                                  paste("FP risk, prior ",priorval[1]),
                                  paste("FP risk, prior ",priorval[2]),
                                  "Likelihood Ratio")

#plot two PIs with asterisks
  plots.2test<-ggplot(PIstatCombined, aes(group, PIs)) +
                      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
                      geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
                      geom_jitter(data=PIstatCombined, aes(group, PIs, fill=category),
                                  position=position_jitter(0.3), shape=21, size=3) +
                      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                                                          panel.border = element_rect(size = 0.5, linetype = "solid",
                                                          colour = "black", fill=NA), legend.position = "top",
                                                          legend.title = element_blank()) +
                      theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+
                      ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
                      geom_signif(comparisons = list(c(unique(PItypeSingleton$name), unique(PItypeDoubleton1$name))),
                                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                                  textsize=5, vjust=0.1) +
                      geom_signif(comparisons = list(c(unique(PItypeSingleton$name), unique(PItypeDoubleton2$name))),
                                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                                  textsize=5, vjust=0.1, margin_top=0.15) +
                      samplesizes.annotate(boxes, samplesizes)

    #add table with results and plot
    plots.2utest<-tableGrob(results.test)
    grid.arrange(plots.2test,plots.2utest, nrow = 1)
  } else { #if there are less or more than two unique group descriptions
    PItype_1 <- na.omit(PItype[[1]])
    PItype_2 <- na.omit(PItype[[2]])
    PItype_3 <- na.omit(PItype[[3]])
    PIname<-c(unique(PItype_1$name), unique(PItype_2$name), unique(PItype_3$name))
    
    test1 = statistical_test(PItype_1$value, PItype_2$value)
    test2 = statistical_test(PItype_1$value, PItype_3$value)
    test3 = statistical_test(PItype_2$value, PItype_3$value)
    results.test <- data.frame(cbind(test1, test2, test3))
    colnames(results.test) = c(paste(PIname[1], PIname[2], sep="\n"),
                                paste(PIname[1], PIname[3], sep="\n"),
                                paste(PIname[2], PIname[3], sep="\n"))
    rownames(results.test) <- c("Significance level",
                                    "MW U-Test, W",
                                    "U-Test p-value", 
                                    "Cohen's D",
                                    "stat. Power",
                                    "Bayes Factor",
                                    "Bayes Factor error",
                                    paste("FP risk, prior ",priorval[1]),
                                    paste("FP risk, prior ",priorval[2]),
                                    "Likelihood Ratio")
  #plot two PIs with asterisks
    plots.2test<-ggplot(PIstatCombined, aes(group, PIs)) +
                        geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
                        geom_boxplot(fill = boxcolors, notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
                        geom_jitter(data=PIstatCombined, aes(group, PIs, fill=category),
                                    position=position_jitter(0.3), shape=21, size=3) +
                        theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(),
                                                            panel.border = element_rect(size = 0.5, linetype = "solid",
                                                            colour = "black", fill=NA), legend.position = "top",
                                                            legend.title = element_blank()) +
                        theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.text.y = element_text(size=18))+
                        ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ xlab("Groups")+ theme(aspect.ratio=3/NofGroups)+
                        geom_signif(comparisons = list(c(unique(PItype_1$name), unique(PItype_2$name))),
                                    map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                                    textsize=5, vjust=0.1, margin_top = 0.1) +
                        geom_signif(comparisons = list(c(unique(PItype_1$name), unique(PItype_3$name))),
                                    map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                                    textsize=5, vjust=0.1, margin_top=0.2) +
                        geom_signif(comparisons = list(c(unique(PItype_2$name), unique(PItype_3$name))),
                                    map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                                    textsize=5, vjust=0.1, margin_top=0.1) +
                        samplesizes.annotate(boxes, samplesizes)
  
      #add table with results and plot
      plots.2utest<-tableGrob(results.test)
      grid.arrange(plots.2test, plots.2utest, nrow = 1)
  }
}

```

```{r Utestpooled, eval=(PIs_present & twogroupstats & PoolGrps), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 10, fig.width = 6, comment=NA, results='asis'}
cat("\n## Statistical tests between pooled groups\n")

  cat("The following experimental groups were pooled into two groups:\n")
reactable(PooledGroups,
  striped = TRUE,
  highlight = TRUE,
  bordered = TRUE,
  resizable = TRUE,
  compact = TRUE,
  fullWidth = FALSE)

    utest = signif(wilcox.test(PIprofilePooled[[1]],PIprofilePooled[[2]])$p.value, 3) #compare the two groups with a U-test and collect p-value
    w.statistic = signif(wilcox.test(PIprofilePooled[[1]],PIprofilePooled[[2]])$statistic, 3)
    #compute effect size Cohen's D
    if(samplesizes[1]==samplesizes[2]){equalN=TRUE}else{equalN=FALSE}   #deterine if the samplesizes are identical
    if(fligner.test(PIstatPooled$PIs,PIstatPooled$group)$p.value<0.05){hv=FALSE}else{hv=TRUE}       #test for homogeneity of variance and set hv TRUE/FALSE
    if(equalN & hv){hedges=FALSE}else{hedges=TRUE}                      #test if we need to apply Hedge's correction
    if(hedges){
      cohend = signif(cohen.d(PIstatPooled$PIs, PIstatPooled$group, hedges.correction = hedges)$estimate, 3) #use effsize package for Hedge's correction
    }else{
      cohend = signif((mean(na.omit(PIprofilePooled[[1]]))-mean(na.omit(PIprofilePooled[[2]])))/sqrt((sd(na.omit(PIprofilePooled[[1]]))^2+sd(na.omit(PIprofilePooled[[2]]))^2)/2), 3) #use simple formula if variances and sample sizes are identical
    }
    #calculate statistical power
    alt = dataset.data[["statistics"]][["two.groups"]][["power"]]
    power=signif(pwr.t2n.test(n1 = samplesizesPooled[1], n2= samplesizesPooled[2], d = cohend, alternative = alt, sig.level = signif[1])$power, 3)
    #calculate Bayes Factor
    bayesF=extractBF(ttestBF(na.omit(PIprofilePooled[[1]]), na.omit(PIprofilePooled[[2]])))
    #calculate FPR for priors set in dataset file#
    #run first prior  
      prior=priorval[1]
      out=calc.FPR(samplesizesPooled,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz1=out[1]
    #run second prior  
      prior=priorval[2]
      out=calc.FPR(samplesizesPooled,utest,prior,abs(cohend))  #output=c(FPR,x0,y0,x1,y1)
      fpz2=out[1]
    #Power and likelihood ratio: NB for two sided test, need 2*y0
      LR=out[5]/(2*out[3])        #lik ratio (Hi1/H0) =y1/2*y0

      #make tidy table of results
    results.utest<-data.frame(values=c(signif[1],
                                       w.statistic,
                                       utest,
                                       cohend,
                                       power,
                                       signif(bayesF$bf, 3),
                                       signif(bayesF$error, 3),
                                       signif(fpz1, 3),
                                       signif(fpz2, 3),
                                       signif(LR, 3)))
    rownames(results.utest)<-c("Significance level",
                               "MW U-Test, W",
                               "MW U-Test, p",
                               "Cohen's D",
                               "stat. Power",
                               "Bayes Factor",
                               "Bayes Factor error",
                               paste("FP risk, prior ",priorval[1]),
                               paste("FP risk, prior ",priorval[2]),
                               "Likelihood Ratio")

#prepare Grob with results table
  plots.2test<-list(tableGrob(results.utest))
        
# plot two PIs with asterisks
  plots.2test[[2]]<-ggplot(PIstatPooled, aes(group, PIs)) +
      geom_hline(yintercept = 0, colour = "#887000", size = 1.2) +
      geom_boxplot(fill = boxcolors[1:2], notch = TRUE, outlier.color=NA, width=0.8, size=0.6) +
      geom_jitter(data=PIstatPooled, aes(group, PIs, fill=category), position=position_jitter(0.3), shape=21, size=3, alpha=0.5) +
      scale_y_continuous(breaks = seq(-1, 1, .2)) +
      theme_light(base_size = 16) + theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), panel.border = element_rect(size = 0.5, linetype = "solid", colour = "black", fill=NA), legend.position = "bottom") +
      scale_fill_discrete(name = "Heat on:")+ #legend title for categories
      theme(axis.text.y = element_text(size=18))+ ylab(paste("PI", learningscore, " [rel. units]", sep = ""))+ theme(aspect.ratio=1)+
      geom_signif(comparisons = list(c(colnames(PIprofilePooled[1]), colnames(PIprofilePooled[2]))), 
                  map_signif_level= c("***"= signif[3],"**"= signif[2], "*"= signif[1]),
                  textsize=4) +
      samplesizes.annotate(boxes[1:2], samplesizesPooled)
  

  #plot
  grid.arrange(grobs = plots.2test, ncol=1, nrow=2)

```

```{r estimationstatspooled, eval=(PIs_present & twogroupstats & PoolGrps), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}
 cat("\n## Estimation statistics for pooled groups\n")
 dabest_groupnames=unique(groupdescriptions) #rename groupnames to pooled groups specifically for dabestr
 unpaired_median_diff <- dabest(PIstatPooled, group, PIs, idx = dabest_groupnames, paired = FALSE) %>% median_diff() #create estimation results list
 print(plot(unpaired_median_diff)) #plot results

```

```{r splitviolinspooled, eval=(PIs_present & twogroupstats & PoolGrps), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}
cat("\n## Split Violin Plot for pooled groups\n")

PIstatPooled$learningscore=dataset.data$statistics$`learning-score`$title #add x-axis value for split violin plots
print(ggplot(PIstatPooled, aes(learningscore, PIs, fill = group)) + scale_fill_manual(values=boxcolors) + geom_split_violin()) #plot spit violin plot

```