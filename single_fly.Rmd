---
title: "Single Fly Descriptive Data Evaluation Sheet"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float: true
---
<style type="text/css">
  body .main-container {
    max-width: 1800px !important;
  }
  h1.title {
  font-size: 38px;
  color: DarkRed;
  text-align: center;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, packages, eval=FALSE, echo=FALSE}
# load packages 
library(ggplot2)
library(tidyr)
library(dygraphs)
library(grid)
library(reshape2)
library(dplyr)
library(gridExtra)
library(yaml)
library(ggsignif)
library(effsize)
library(pwr)
library(BayesFactor)
library(genefilter)  # if not available for newest version: setRepositories(addURLs = c(CRANxtras = "http://www.stats.ox.ac.uk/pub/RWin"))
library(seewave)
library(zoo)

## source the script with the functions needed for analysis
source("readXMLdatafile.R")
source("DTS_plotfunctions.R")
```

<center><h2>for time series experiment `r paste(flyname)`</h2></center>
<center>Rendered on `r format(Sys.time(), '%d %B %Y')`</center>

# Metadata

**Date and time of the experiment:** `r paste(experiment$dateTime)`  
**Raw data file (XML):** `r paste('<a href="../', basename(xml_name), '">', flyname, '</a>', sep = "")`  
**Experimenter:** `r paste(experimenter$firstname, experimenter$lastname, sep = " ")`; **ORCID:** [`r paste(experimenter$orcid)`](http://orcid.org/`r paste(experimenter$orcid)`)  
**Experiment description:** `r paste(experiment$description)`  
**Experiment duration:** `r paste(experiment$duration)`s  
**Arena type:** `r paste(experiment$arena_type)`; **Measurement device:** `r paste(experiment$meter_type)`  
**Fly description:** `r paste(fly$description)`; **FlyBase ID:** [`r paste(fly$flybase)`](http://flybase.org/reports/`r paste(fly$flybase)`)  
**Sampling rate:** `r paste(experiment$sample_rate)`Hz
```{r sr_condition, echo=FALSE}
sampleratecondition <- round(real_sample_rate)>20
```

```{r samplerate, eval=sampleratecondition, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, comment=NA, results = 'asis'}
cat("<b>Actual samplingrate: </b>", paste(signif(real_sample_rate,4)), " Hz; <b>Downsampled sampling rate (target 20 Hz):</b> ", paste(signif(down_sample_rate,4)), " Hz")
```

# Experimental Design
```{r expdesign, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 3, fig.width = (NofPeriods+1)}
    #plot table of period sequence
    periods=t(sequence)
    colnames(periods)<-sprintf("Period %s",1:NofPeriods)
    grid.table(periods)
```

# Time Traces
## Interactive Time Traces

```{r dytracesraw, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 4, fig.width = 12}    
    
    ##dyplot traces
    dytraces(traces)

```

## Interactive Time Traces (Downsampled data)

```{r dytracesdown, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 4, fig.width = 12}    
    
    ##dyplot traces
    dytraces(rawdata)

```

## Time Traces by Period (20Hz)

```{r PeriodTraces, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 10}

#add columns for PIs to sequence data
    sequence$lambda <- NA

    for(i in 1:NofPeriods){
      
      #save colors for later plotting
      if(sequence$outcome[i]==0){
        sequence$color[i]="lightyellow"
        sequence$histocolor[i]="darkgreen"
      } else {
        sequence$color[i]="orange"
        sequence$histocolor[i]="orange"
        }
     if(sequence$contingency[i]==""){
        sequence$color[i]=NA
        sequence$histocolor[i]="red"
        }
      
      ##only look at period data
      temp  <- rawdata[rawdata$period == i, ]
      keeps = c("a_pos","fly")
      period.data[[i]] <- temp[keeps] #list only arena position and fly behavior data by period
      
      if(sequence$type[i]=="fs"||sequence$type[i]=="yt"||sequence$type[i]=="color"||sequence$type[i]=="optomotorR"||sequence$type[i]=="optomotorL")
      {
        ## plot the fly behavior and arena position time traces
        fly_pos_traces(temp)
      }

      ##Calculate period histograms
      #fly behavior
      flyhistos[[i]] <- ggplot(data=temp, aes_string(temp$fly)) +
        geom_histogram(binwidth = 3, fill = sequence$histocolor[i]) +
        labs(x=paste(FlyBehavior, "[arb units]"), y="frequency") +
        xlim(maxfly) +
        ggtitle(paste(flyname, "Period", i))
      
      #arena position
      if(sequence$type[i]=="fs"||sequence$type[i]=="color")
      {
        poshistos[[i]] <- ggplot(data=temp, aes_string(temp$a_pos)) +
          geom_histogram(binwidth=10, fill = sequence$histocolor[i]) +
          labs(x="Arena Position [degrees*10]", y="frequency") +
          xlim(-1800,1800) +
          ggtitle(paste(flyname, "Period", i))
      }
      
      
      ##calculate PIs
      ##create data.frame for adding PIs if it doesn't eist, yet
      if(!exists("PIprofile")){PIprofile <- data.frame(matrix(ncol = NofPeriods))}
      
      if(sequence$type[i]=="fs"||sequence$type[i]=="color") #for arena position
      {
        t1 = sum(abs(temp$a_pos) >= 450 & abs(temp$a_pos) <= 1350)
        t2 = nrow(temp)-t1
        sequence$lambda[i] = (t1-t2)/(t1+t2)
        if (sequence$contingency[i] == '2_4_Q'){sequence$lambda[i]=-sequence$lambda[i]}
        if(l==1){PIprofile[1,i]=sequence$lambda[i]}
      } else if (sequence$type[i]=="yt" || sequence$type[i]=="sw_blue" || sequence$type[i]=="sw_green") #calculate torque PIs
      {
        t2 = table(sign(temp$fly))[1]
        t1 = nrow(temp)-t2
        sequence$lambda[i] = (t1-t2)/(t1+t2)
        if (sequence$contingency[i] == 'right_torque'){sequence$lambda[i]=-sequence$lambda[i]}
        if(l==1){PIprofile[1,i]=sequence$lambda[i]}
      }
    } #for Number of Periods
    
```

# Histograms
## Fly Behavior Histograms

```{r FlyHistogram, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8}    
    
    ## plot position and fly histograms ##
    # add fly behavior pooled histogram
    flyhistos[[NofPeriods+1]] <- ggplot(data=rawdata, aes_string(rawdata$fly)) + 
      geom_histogram(binwidth=3) + 
      labs(x=paste(FlyBehavior, "[arb units]"), y="frequency") + 
      xlim(-maxfly) +
      ggtitle(paste(flyname, "total"))
    
    # add pooled position histogram - if there are any periods with meaningful position data
    if ('fs' %in% sequence$type || 'color' %in% sequence$type) {
      poshistos[[NofPeriods+1]] <- ggplot(data=rawdata, aes_string(rawdata$a_pos)) + 
      geom_histogram(binwidth=10) +
      labs(x="position [degrees*10]", y="frequency") + 
      xlim(-1800,1800) +
      ggtitle(paste(flyname, "total"))
    }
    
    ##write histograms
    #fly behavior
    multiplot(plotlist = flyhistos, cols=round(NofPeriods/5))
```

```{r PositionHistogram, eval=('fs' %in% sequence$type || 'color' %in% sequence$type), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    
      cat("\n## Arena Position Histograms\n")
      multiplot(plotlist = Filter(Negate(is.null), poshistos), cols=round(sum(poshistos!="NULL")/5)) #only print position histograms if there are any

```

<!-- Evaluate optomotor data if they are present -->

```{r om, echo=FALSE}
om <- any(grepl("optomotor", sequence$type)==TRUE)    ###determine if there are optomotor periods
if (om & any(!grepl("optomotor", sequence$type)==TRUE)){   ###if there are non-optomotor periods...
  if (grepl("optomotor", sequence$type[1]) & grepl("optomotor", tail(sequence$type, 1))){ ###...and the optomotor periods are in the beginning and the end
    beforeafter = TRUE
    om = FALSE
  }
}
```

`r if (om | beforeafter) '# Optomotor evaluations'`
`r if (om | beforeafter) '## Optomotor traces (right/left)'`

```{r OptomotorTraces, eval=om, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

### extract optomotor traces and generate dataframe for right (clockwise) turning arena
OMperiods = which(grepl("optomotorR", sequence$type)) #collect the right turning OM periods
rightOMdata <- generateOMdata(OMperiods) #call function which assembles optomotor data for the identified periods
plotrawOMtraces(rightOMdata) #call function to pot the OM traces

### extract optomotor traces and generate dataframe for left turning (counter-clockwise) arena
OMperiods = which(grepl("optomotorL", sequence$type)) #collect the left turning OM periods
leftOMdata <- generateOMdata(OMperiods) #call function which assembles optomotor data for the identified periods
leftOMdata$time=leftOMdata$time+max(rightOMdata$time) #make left data start after right data
plotrawOMtraces(leftOMdata)  #call function to pot the OM traces

### generate averaged optomotor responses over both rotation directions
tempOMdata=rbind(rightOMdata,leftOMdata) #combine left and right OMdata in one dataframe
tempOMdata=aggregate(tempOMdata$fly,FUN=mean,by=list(tempOMdata$time)) #average across periods
colnames(tempOMdata) <- c("time", as.character(flyname)) #set dataframe names

if(!exists("OMdata"))
{
  OMdata=tempOMdata
} else {
  OMdata[[as.character(flyname)]]=tempOMdata[[as.character(flyname)]]
}
```

`r if (beforeafter) '### Optomotor traces at start'`

```{r OptomotorTracesBefore, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

### extract and plot optomotor traces for right (clockwise) turning arena at start of experiment
OMperiods = which(grepl("optomotorR", head(sequence$type))) #collect the right turning OM periods in the first half of the experiment
rightOMdataBefore <- generateOMdata(OMperiods) #call function which assembles optomotor data for the identified periods
plotrawOMtraces(rightOMdataBefore) #call function to pot the OM traces

### extract optomotor traces and generate dataframe for left turning (counter-clockwise) arena at start of experiment
OMperiods = which(grepl("optomotorL", head(sequence$type))) #collect the left turning OM periods in the first half of the experiment
leftOMdataBefore <- generateOMdata(OMperiods) #call function which assembles optomotor data for the identified periods
leftOMdataBefore$time=leftOMdataBefore$time+max(rightOMdataBefore$time) #make left data start after right data
plotrawOMtraces(leftOMdataBefore)  #call function to pot the OM traces

### generate averaged optomotor responses over both rotation directions
tempOMdataBefore=rbind(rightOMdataBefore,leftOMdataBefore) #combine left and right OMdata in one dataframe
tempOMdataBefore=aggregate(tempOMdataBefore$fly,FUN=mean,by=list(tempOMdataBefore$time)) #average across periods
colnames(tempOMdataBefore) <- c("time", as.character(flyname)) #set dataframe names

if(!exists("OMdataBefore"))
{
  OMdataBefore=tempOMdataBefore
} else {
  OMdataBefore[[as.character(flyname)]]=tempOMdataBefore[[as.character(flyname)]]
}
```

`r if (beforeafter) '### Optomotor traces at end'`

```{r OptomotorTracesAfter, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

### extract optomotor traces and generate dataframe for right (clockwise) turning arena at the end of the experiment
OMperiods = which(grepl("optomotorR", tail(sequence$type, 8)))+NofPeriods-8 #collect the right turning OM periods in the last half of the experiment
rightOMdataAfter <- generateOMdata(OMperiods) #call function which assembles optomotor data for the identified periods
plotrawOMtraces(rightOMdataAfter) #call function to pot the OM traces

### extract optomotor traces and generate dataframe for left turning (counter-clockwise) arena at end of experiment
OMperiods = which(grepl("optomotorL", tail(sequence$type, 8)))+NofPeriods-8 #collect the left turning OM periods in the last half of the experiment
leftOMdataAfter <- generateOMdata(OMperiods) #call function which assembles optomotor data for the identified periods
leftOMdataAfter$time=leftOMdataAfter$time+max(rightOMdataAfter$time) #make left data start after right data
plotrawOMtraces(leftOMdataAfter)  #call function to pot the OM traces

### generate averaged optomotor responses over both rotation directions
tempOMdataAfter=rbind(rightOMdataAfter,leftOMdataAfter) #combine left and right OMdata in one dataframe
tempOMdataAfter=aggregate(tempOMdataAfter$fly,FUN=mean,by=list(tempOMdataAfter$time)) #average across periods
colnames(tempOMdataAfter) <- c("time", as.character(flyname)) #set dataframe names

if(!exists("OMdataAfter"))
{
  OMdataAfter=tempOMdataAfter
} else {
  OMdataAfter[[as.character(flyname)]]=tempOMdataAfter[[as.character(flyname)]]
}
```

`r if (om | beforeafter) '## Averaged optomotor response'`

```{r OptomotorAverage, eval=om, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

plotaveOMtraces(OMdata)
```

`r if (beforeafter) '### Averaged optomotor response at start'`

```{r OptomotorAverageBefore, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

plotaveOMtraces(OMdataBefore)
```

`r if (beforeafter) '### Averaged optomotor response at end'`

```{r OptomotorAverageAfter, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

plotaveOMtraces(OMdataAfter)
```

`r if (om | beforeafter) '## Further optomotor evaluations'`

```{r moreOptomotor, eval=om, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

tempOMparams <- OMparamextract(OMdata) #call fucntion for parameter estimation
kable(tempOMparams)  #plot table with data

###collect all coefficients in dataframe for the group
if(!exists("OMparams"))
{
  OMparams=tempOMparams
} else {
  OMparams[as.character(flyname),]=tempOMparams
}

```

`r if (beforeafter) '### Optomotor parameters at start'`

```{r OMparamsBefore, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

tempOMparamsBefore<-OMparamextract(OMdataBefore) #call fucntion for parameter estimation
kable(tempOMparamsBefore)  #plot table with data

###collect all coefficients in dataframe for the group
if(!exists("OMparamsBefore"))
{
  OMparamsBefore=tempOMparamsBefore
} else {
  OMparamsBefore[as.character(flyname),]=tempOMparamsBefore
}

```

`r if (beforeafter) '### Optomotor parameters at end'`

```{r OMparamsAfter, eval=beforeafter, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

tempOMparamsAfter<-OMparamextract(OMdataAfter) #call fucntion for parameter estimation
kable(tempOMparamsAfter)  #plot table with data

###collect all coefficients in dataframe for the group
if(!exists("OMparamsAfter"))
{
  OMparamsAfter=tempOMparamsAfter
} else {
  OMparamsAfter[as.character(flyname),]=tempOMparamsAfter
}

```


# Power spectrum and spectrogram

```{r spectra, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8}
    meanspec(rawdata$fly, f = down_sample_rate, wl = 600) #plot mean power spectrum for each fly
    title(paste(FlyBehavior, "Powerspectrum", flyname))
    spectro(rawdata$fly, f = down_sample_rate, wl=600) #plot spectrogram for each fly
    title(paste(FlyBehavior, "Spectrogram", flyname))
    speclist[[l]] = as.data.frame(meanspec(rawdata$fly, f = down_sample_rate, wl = 600, plot = FALSE)) #collect each spectrum for later averaging
```


```{r PIs, eval=(!all(is.na(sequence$lambda))), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8, comment=NA, results='asis'}
cat("\n# Learning and avoidance scores\n")

      barplot(as.vector(na.omit(sequence$lambda)), main = paste("Performance Indices", flyname),
            xlab="Time [periods]",
            ylab="PI [rel. units]",
            space=0,
            col = as.vector(na.omit(sequence$color)))
```
# Dwelling time distribution
## punished

```{r dwellingpunished, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8}


for(i in 1:NofPeriods){
  temp  <- rawdata[rawdata$period == i, ]
  dwell = temp[temp["fly"] < 0, ] # sort negative data
  dwell <- melt(table(lengths(split(dwell$time, cumsum(c(TRUE, diff(dwell$time) != 50)))))) #finds cumulative data and adds it to a melted table
  #sum = sum(dwell$value)
  dwell$perctest = 100-(cumsum(dwell$value/(sum(dwell$value)))*100) # subtracts the cumulative
  dwell$Var1 = (dwell$Var1 * 0.05)
  dwell <- na.omit(transform(dwell, perctest = c(NA, perctest[-nrow(dwell)]))) # shifting the data downwards
  insert <- c(0,(max(dwell$value)),100)
  dwell = rbind(dwell, insert)
  mediandwell[[i]] = median(dwell$Var1)
  medianmelt = melt(mediandwell)
  
  ##plot command can be put into a function in DTS_plotfunctions.R
  dwellingtime[[i]] <- ggplot(data=dwell, aes(x=Var1, y=perctest)) +
    geom_line(color="red")+
    geom_point()+
    scale_y_log10( breaks=c(0,10,100))+
    scale_x_log10() +
    ggtitle(paste(flyname, "Period", i, "Punished"))+
    theme_light() +
    labs(x="time [sec]", y="% events") +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    theme(plot.title = element_text(color="black", size=12, face="bold", hjust = 0.5))
}

dwellingtime[[NofPeriods+1]] <- ggplot(medianmelt, aes(L1)) + 
  geom_bar(aes(weight = value)) +
  ggtitle(paste("Punished median dwelling time", flyname)) +
  theme_light() +
  labs(x="period", y="median dwelling time [sec]") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(plot.title = element_text(color="black", size=12, face="bold", hjust = 0.5)) +
  scale_x_continuous(breaks = seq(len = 100))

multiplot(plotlist = dwellingtime, cols=2)

```

```{r unpunished, eval=('fs' %in% sequence$type || 'color' %in% sequence$type), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    
      cat("\n## Unpunished Dwelling time\n")

for(i in 1:NofPeriods){
  temp  <- rawdata[rawdata$period == i, ]
  dwell = temp[temp["fly"]  >= 0, ] # sort negative data
  dwell <- melt(table(lengths(split(dwell$time, cumsum(c(TRUE, diff(dwell$time) != 50)))))) #finds cumulative data and adds it to a melted table
  dwell = dwell[-1,]
  sum = sum(dwell$value)
  dwell$perctest = 100-(cumsum(dwell$value/sum)*100) # subtracts the cumulative
  dwell$Var1 = (dwell$Var1 * 0.05)
  dwell <- na.omit(transform(dwell, perctest = c(NA, perctest[-nrow(dwell)]))) # shifting the data downwards
  insert <- c(0,(min(dwell$value)),100)
  dwell = rbind(dwell, insert)

  mediandwell[[i]] = median(dwell$Var1)
  medianmelt = melt(mediandwell)
  dwellingtime[[i]] <- ggplot(data=dwell, aes(x=Var1, y=perctest)) +
    geom_line(color="red")+
    geom_point()+
    scale_y_log10( breaks=c(0,10,100))+
    scale_x_log10() +
    ggtitle(paste(flyname, "Period", i, "Unpunished"))+
    theme_light() +
    labs(x="time [sec]", y="% events") +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    theme(plot.title = element_text(color="black", size=12, face="bold", hjust = 0.5))

}
dwellingtime[[NofPeriods+1]] <- ggplot(medianmelt, aes(L1)) + 
  geom_bar(aes(weight = value)) +
  ggtitle(paste("median dwelling time", flyname)) +
  theme_light() +
  labs(x="period", y="Unpunished median dwelling time [sec]") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(plot.title = element_text(color="black", size=12, face="bold", hjust = 0.5)) +
  scale_x_continuous(breaks = seq(len = 100))
sumpos = dwell$Var1*dwell$value
sumpos = sum(sumpos)

multiplot(plotlist = dwellingtime, cols=2)


```

```{r scatterpunished, eval=('fs' %in% sequence$type || 'color' %in% sequence$type), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    
      cat("\n## Scatter Dwelling time\n")

dwellscatter = list()
for(i in 1:NofPeriods){
  temp  <- rawdata[rawdata$period == i, ]
  dwell = temp[temp["fly"] < 0, ] # sort negative data
  dwell <- lengths(split(dwell$time, cumsum(c(TRUE, diff(dwell$time) != 50))))
  dwell = melt(dwell)
  dwell = (dwell * 0.05)
  dwell = melt(dwell)
  dwell["period"] <- i
  dwellscatter[[i]] <- dwell
}
 dwell_data = do.call(rbind, dwellscatter)
max = max(dwell_data$value)
ggerrorplot(dwell_data, x = "period", y = "value", 
            desc_stat = "mean_sd", color = "black",
            ylim = c(0, max),
            add = "jitter", add.params = list(color = "darkgray")) +
        theme(plot.title = element_text(color="black", size=12, face="bold", hjust = 0.5))+
  labs(x="Period", y="Dwelling time [sec]")+
  ggtitle(paste("Punished dwelling time", flyname)) 
  
```

```{r scatterunpunished, eval=('fs' %in% sequence$type || 'color' %in% sequence$type), echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    
      cat("\n## Scatter Dwelling time\n")

dwellscatter = list()
for(i in 1:NofPeriods){
  temp  <- rawdata[rawdata$period == i, ]
  dwell = temp[temp["fly"] >= 0, ] # sort negative data
  dwell <- lengths(split(dwell$time, cumsum(c(TRUE, diff(dwell$time) != 50))))
  dwell = melt(dwell)
 # dwell = dwell[dwell[,ncol(dwell)]>1,]
  dwell = (dwell * 0.05)
  dwell = melt(dwell)
  dwell["period"] <- i
  dwellscatter[[i]] <- dwell
}

 dwell_data = do.call(rbind, dwellscatter)

ggerrorplot(dwell_data, x = "period", y = "value", 
            desc_stat = "mean_sd", color = "black",fill = as.vector(na.omit(sequence$color)),
            add = "jitter", add.params = list(color = "gray")) +
        theme(plot.title = element_text(color="black", size=12, face="bold", hjust = 0.5))+
  labs(x="Period", y="Dwelling time [sec]")+
  ggtitle(paste("Unpunished dwelling time", flyname)) 
  
```

```{r totaldwelling, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 8, fig.width = 5}
cat("\n## Dwelling time per period\n")

sumcom = list()
for(i in 1:NofPeriods){
  temp  <- rawdata[rawdata$period == i, ]
  dwellpos = temp[temp["fly"]  >= 0, ] # sort negative data
  dwellpos <- melt(table(lengths(split(dwellpos$time, cumsum(c(TRUE, diff(dwellpos$time) != 50)))))) #finds cumulative data and adds it to a melted table
  dwellpos$Var1 = (dwellpos$Var1 * 0.05)
  sumpos = sum(dwellpos$Var1*dwellpos$value)
  
  dwellneg = temp[temp["fly"]  < 0, ] # sort negative data
  dwellneg <- melt(table(lengths(split(dwellneg$time, cumsum(c(TRUE, diff(dwellneg$time) != 50)))))) #finds cumulative data and adds it to a melted table
  dwellneg$Var1 = (dwellneg$Var1 * 0.05)
  sumcom[[i]] = sum(dwellneg$Var1*dwellneg$value)+sumpos

}
sumcom = melt(sumcom)
sumcom = rbind(sumcom, (c(format(round((mean(sumcom$value)), 2), nsmall = 2),"Average")))
sumcom = sumcom %>% 
  rename(
    Time = value,
    "Period/Average" = L1
    )
table <- ggtexttable((sumcom), rows = NULL, 
                        theme = ttheme("mBlue"))
table
```
```