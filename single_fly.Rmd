<style type="text/css">
  body .main-container {
    max-width: 1800px !important;
  }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, packages, eval=FALSE, echo=FALSE}
# load packages 
library(ggplot2)
library(tidyr)
library(dygraphs)
library(grid)
library(reshape2)
library(dplyr)
library(gridExtra)
library(yaml)
library(ggsignif)
library(effsize)
library(pwr)
library(BayesFactor)
library(genefilter)
library(seewave)

## source the script with the functions needed for analysis
source("readXMLdatafile.R")
source("DTS_plotfunctions.R")
```

<center><h1>Single Fly Descriptive Data Evaluation Sheet</h1></center>
<center><h2>for time series experiment `r paste(flyname)`</h2></center>

### 1. Metadata:

**Date and time of the experiment:** `r paste(experiment$dateTime)`  
**Experimenter:** `r paste(experimenter$firstname, experimenter$lastname, sep = " ")`; **ORCID:** [`r paste(experimenter$orcid)`](http://orcid.org/`r paste(experimenter$orcid)`)  
**Experiment description:** `r paste(experiment$description)`  
**Experiment duration:** `r paste(experiment$duration)`s  
**Sampling rate:** `r paste(experiment$sample_rate)`Hz; **Arena type:** `r paste(experiment$arena_type)`; **Torquemeter type:** `r paste(experiment$meter_type)`  
**Fly description:** `r paste(fly$description)`; **FlyBase ID:** [`r paste(fly$flybase)`](http://flybase.org/reports/`r paste(fly$flybase)`)

### 2. Experimental Design:
```{r expdesign, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 3, fig.width = 9}
    #plot table of period sequence
    periods=t(sequence)
    colnames(periods)<-sprintf("Period %s",1:NofPeriods)
    grid.table(periods)
```

### 3. Interactive Time Traces:

```{r dytraces, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 4, fig.width = 12}    
    
    ##dyplot traces
    dytraces(rawdata)

```

### 4. Time Traces by Period:

```{r PeriodTraces, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 10}

    for(i in 1:NofPeriods){
      
      #save colors for later plotting
      if(sequence$outcome[i]==0){sequence$color[i]="lightyellow"} else {sequence$color[i]="orange"}
      if(sequence$outcome[i]==0){sequence$histocolor[i]="darkgreen"} else {sequence$histocolor[i]="orange"}
      
      #only look at period data
      temp  <- rawdata[rawdata$period == i, ]
      keeps = c("a_pos","torque")
      period.data[[i]] <- temp[keeps] #list only position and torque data by period
      
      if(sequence$type[i]=="fs"||sequence$type[i]=="color"||sequence$type[i]=="optomotor")
      {
        ## plot the torque and position time traces
        trq_pos_traces(temp)
      }

      #Calculate period histograms
      #torque
      trqhistos[[i]] <- ggplot(data=temp, aes_string(temp$torque)) +
        geom_histogram(binwidth = 3, fill = sequence$histocolor[i]) +
        labs(x="torque [arb units]", y="frequency") +
        xlim(-600,600) +
        ggtitle(paste(flyname, "Period", i))
      
      #position
      if(sequence$type[i]=="fs"||sequence$type[i]=="color"||sequence$type[i]=="optomotor")
      {
        poshistos[[i]] <- ggplot(data=temp, aes_string(temp$a_pos)) +
          geom_histogram(binwidth=10, fill = sequence$histocolor[i]) +
          labs(x="position [arb units]", y="frequency") +
          xlim(-2047,2048) +
          ggtitle(paste(flyname, "Period", i))
      }
      
      ##calculate PIs
      ##create data.frame for adding PIs if it doesn't eist, yet
      if(!exists("PIprofile")){PIprofile <- data.frame(matrix(ncol = NofPeriods))}
      
      #for position
      if(sequence$type[i]=="fs"||sequence$type[i]=="color")
      {
        t1 = sum(abs(temp$a_pos) >= 512 & abs(temp$a_pos) <= 1538)
        t2 = nrow(temp)-t1
        sequence$lambda[i] = (t1-t2)/(t1+t2)
        if (sequence$contingency[i] == '2_4_Q'){sequence$lambda[i]=-sequence$lambda[i]}
        if(l==1){PIprofile[1,i]=sequence$lambda[i]}
      }
      #for torque
      #if(sequence$type[i]=="yt"||"sw_blue"||"sw_green")
      #{}
    } #for Number of Periods
    
```

### 5. Torque Histograms

```{r TorqueHistogram, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8}    
    
    ## plot position and torque histograms ##
    #torque
    trqhistos[[NofPeriods+1]] <- ggplot(data=rawdata, aes_string(rawdata$torque)) + 
      geom_histogram(binwidth=3) + 
      labs(x="torque [arb units]", y="frequency") + 
      xlim(-600,600) +
      ggtitle(paste(flyname, "total"))
    
    #position
    poshistos[[NofPeriods+1]] <- ggplot(data=rawdata, aes_string(rawdata$a_pos)) + 
      geom_histogram(binwidth=10) +
      labs(x="position [arb units]", y="frequency") + 
      xlim(-2047,2048) +
      ggtitle(paste(flyname, "total"))
    
    ##write histograms
    #torque
    multiplot(plotlist = trqhistos, cols=2)
```

### 6. Position Histograms
    
```{r PositionHistogram, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8}    
    multiplot(plotlist = poshistos, cols=2)
```

### 7. Power spectrum and spectrogram:

```{r spectra, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8}
    meanspec(rawdata$torque, f = samplerate, wl = 600) #plot mean power spectrum for each fly
    title(paste("Torque-Powerspectrum", flyname))
    spectro(rawdata$torque, f = samplerate, wl=600) #plot spectrogram for each fly
    title(paste("Torque-Spectrogram", flyname))
    speclist[[l]] = as.data.frame(meanspec(rawdata$torque, f = samplerate, wl = 600, plot = FALSE)) #collect each spectrum for later averaging
```

### 8. Learning and avoidance scores:

```{r PIs, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8}
    barplot(sequence$lambda, main = paste("Performance Indices", flyname),
            xlab="Time [periods]",
            ylab="PI [rel. units]",
            space=0,
            col = sequence$color)
```

