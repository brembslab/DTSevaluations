<style type="text/css">
  body .main-container {
    max-width: 1800px !important;
  }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, packages, eval=FALSE, echo=FALSE}
# load packages 
library(ggplot2)
library(tidyr)
library(dygraphs)
library(grid)
library(reshape2)
library(dplyr)
library(gridExtra)
library(yaml)
library(ggsignif)
library(effsize)
library(pwr)
library(BayesFactor)
library(genefilter) # if not available for newest version: setRepositories(addURLs = c(CRANxtras = "http://www.stats.ox.ac.uk/pub/RWin"))
library(seewave)

## source the script with the functions needed for analysis
source("readXMLdatafile.R")
source("DTS_plotfunctions.R")
```

<center><h1>Single Fly Descriptive Data Evaluation Sheet</h1></center>
<center><h2>for time series experiment `r paste(flyname)`</h2></center>

### 1. Metadata:

**Date and time of the experiment:** `r paste(experiment$dateTime)`  
**Experimenter:** `r paste(experimenter$firstname, experimenter$lastname, sep = " ")`; **ORCID:** [`r paste(experimenter$orcid)`](http://orcid.org/`r paste(experimenter$orcid)`)  
**Experiment description:** `r paste(experiment$description)`  
**Experiment duration:** `r paste(experiment$duration)`s  
**Sampling rate:** `r paste(experiment$sample_rate)`Hz; **Arena type:** `r paste(experiment$arena_type)`; **Torquemeter type:** `r paste(experiment$meter_type)`  
**Fly description:** `r paste(fly$description)`; **FlyBase ID:** [`r paste(fly$flybase)`](http://flybase.org/reports/`r paste(fly$flybase)`)

### 2. Experimental Design:
```{r expdesign, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 10, fig.width = 9}
    #plot table of period sequence
    periods=t(sequence)

    #check if number of periods in metadata is true
    if (ncol(periods) != NofPeriods) {
      NofPeriods = ncol(periods)
    }
    colnames(periods)<-sprintf("Period %s",1:NofPeriods)
    
    #transpose the table so that it doesn't go out of the boudaries
    transposed_periods <- t(periods)
    grid.table(transposed_periods)
```

### 3. Interactive Time Traces:

```{r dytraces, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 4, fig.width = 12}    
    
    ##dyplot traces
    if (sequence$type[1] == "OptomotoR" | sequence$type[1] == "OptomotoL") {
      dytraces_platform(rawdata)
    } else {
      dytraces(rawdata)
    }
```

### 4. Time Traces by Period:

```{r PeriodTraces, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 10}

    #variables needed for platform function
    countL = 1
    countR = 1
      
    for(i in 1:NofPeriods){
      
      #save colors for later plotting
      if(sequence$outcome[i]==0){sequence$color[i]="lightyellow"} else {sequence$color[i]="orange"}
      if(sequence$outcome[i]==0){sequence$histocolor[i]="darkgreen"} else {sequence$histocolor[i]="orange"}
      
      #only look at period data
      temp  <- rawdata[rawdata$period == i, ]
      
      if (sequence$type[i] == "OptomotoL" || sequence$type[i] == "OptomotoR") {
        keeps = c("arena","fly")
      } else {
        keeps = c("a_pos","torque")
      }      
      period.data[[i]] <- temp[keeps] #list only position and torque/platform data by period
      
      if(sequence$type[i]=="fs"||sequence$type[i]=="color"||sequence$type[i]=="optomotor")
      {
        ## plot the torque and position time traces
        trq_pos_traces(temp)
      }

      #Calculate period histograms
      
      #platform (distinguish between OptomotoR and OptomotoL)
      if (sequence$type[i] == "OptomotoR") {
        flyhistosR[[countR]] <- ggplot(data=temp, aes_string(temp$fly)) +
          geom_histogram(binwidth = 0.0175, fill = sequence$histocolor[i]) +
          labs(x="fly [arb units]", y="frequency") +
          xlim(-3.2, 0) +
          ggtitle(paste(flyname, "Period", i, "OptomotoR"))
        #for later histograms of pooled periods
        optomotoR_flydata[countR] <- c(period.data[[i]]["fly"])
        countR = countR+1
      } else if (sequence$type[i] == "OptomotoL") {
        flyhistosL[[countL]] <- ggplot(data=temp, aes_string(temp$fly)) +
          geom_histogram(binwidth = 0.0175, fill = sequence$histocolor[i]) +
          labs(x="fly [arb units]", y="frequency") +
          xlim(-3.2, 0) +
          ggtitle(paste(flyname, "Period", i, "OptomotoL"))
        optomotoL_flydata[countL] <- c(period.data[[i]]["fly"])
        countL = countL+1
      }

      #torque
      trqhistos[[i]] <- ggplot(data=temp, aes_string(temp$torque)) +
        geom_histogram(binwidth = 3, fill = sequence$histocolor[i]) +
        labs(x="torque [arb units]", y="frequency") +
        xlim(-600,600) +
        ggtitle(paste(flyname, "Period", i))
      
      #position
      if(sequence$type[i]=="fs" | sequence$type[i]=="color" | sequence$type[i]=="optomotor")
      {
        poshistos[[i]] <- ggplot(data=temp, aes_string(temp$a_pos)) +
          geom_histogram(binwidth=10, fill = sequence$histocolor[i]) +
          labs(x="position [arb units]", y="frequency") +
          xlim(-2047,2048) +
          ggtitle(paste(flyname, "Period", i))
      }
      
      ##calculate PIs
      ##create data.frame for adding PIs if it doesn't eist, yet
      if(!exists("PIprofile")){PIprofile <- data.frame(matrix(ncol = NofPeriods))}
      
      #for position
      if(sequence$type[i]=="fs"||sequence$type[i]=="color")
      {
        t1 = sum(abs(temp$a_pos) >= 512 & abs(temp$a_pos) <= 1538)
        t2 = nrow(temp)-t1
        sequence$lambda[i] = (t1-t2)/(t1+t2)
        if (sequence$contingency[i] == '2_4_Q'){sequence$lambda[i]=-sequence$lambda[i]}
        if(l==1){PIprofile[1,i]=sequence$lambda[i]}
      }
      #for torque
      #if(sequence$type[i]=="yt"||"sw_blue"||"sw_green")
      #{}
    } #for Number of Periods
    
```

### 5. Torque or Platform Histograms/Traces

```{r Torque/PlatformHistogram, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 16}    
    
    ## plot position and torque histograms ##

    #platform
    if (sequence$type[1]=="OptomotoL"||sequence$type[1]=="OptomotoR") {
      #restructuring of the data
    # optomotoR_flydata[[12]] <- optomotoL_flydata[[1]][1:2000] #temporary
    # optomotoL_flydata[[1]] <- optomotoL_flydata[[1]][2000:length(optomotoL_flydata[[1]])]#temporary
 
    #fit "optomotoL_flydata" list for the "data.frame()" function
    optomotoL_flydata <- lapply(optomotoL_flydata, function(x) { length(x) <- min(lengths(optomotoL_flydata)); x })
    flytracesL[[l]] <- rowMeans(data.frame(optomotoL_flydata))
    flytracesL_data_frame <- data.frame(flytracesL[[l]], seq(0, (length(flytracesL[[l]])-1)*10, by=10))
    names(flytracesL_data_frame) <- c("fly", "time")
      #create data frame for pooled traces plot
    fly <- unlist(optomotoL_flydata)
    period <- rep(c(1:length(optomotoL_flydata)), each=length(optomotoL_flydata[[1]]))
    time <- rep(seq(0, (length(optomotoL_flydata[[1]])-1)*10, by=10), times=length(optomotoL_flydata))
    periodL <- data.frame(fly, period, time)
    
    #fit "optomotoR_flydata" list for the "data.frame()" function
    optomotoR_flydata <- lapply(optomotoR_flydata, function(x) {length(x) <- min(lengths(optomotoR_flydata)); x}) 
    flytracesR[[l]] <- rowMeans(data.frame(optomotoR_flydata))     
    flytracesR_data_frame <- data.frame(flytracesR[[l]], seq(0, (length(flytracesR[[l]])-1)*10, by=10))
    names(flytracesR_data_frame) <- c("fly", "time") #final data frame for single trace
      #create data frame for pooled traces plot
    fly <- unlist(optomotoR_flydata)
    period <- rep(c(1:length(optomotoR_flydata)), each=length(optomotoR_flydata[[1]]))
    time <- rep(seq(0, (length(optomotoR_flydata[[1]])-1)*10, by=10), times=length(optomotoR_flydata))
    periodR <- data.frame(fly, period, time)#final data frame for multi traces
    }
    
    
      #pooled histograms
    flyhistosL[[length(flyhistosL)+1]] <- ggplot(data=periodL, aes(periodL$fly)) +
      geom_histogram(binwidth=0.0175) + 
      scale_color_gradientn(colours=rainbow(4)) +
      labs(x="fly [arb units]", y="frequency") + 
      xlim(-3.2, 0) +
      ggtitle(paste(flyname, "total of left periods"))
    flyhistosR[[length(flyhistosR)+1]] <- ggplot(data=periodR, aes(periodR$fly, colour = periodR$period)) +
      geom_histogram(binwidth=0.0175) + 
      scale_color_gradientn(colours=rainbow(4)) +
      labs(x="fly [arb units]", y="frequency") + 
      xlim(-3.2, 0) +
      ggtitle(paste(flyname, "total of right periods"))
    
      #pooled traces
    flytraces[[1]] <- ggplot(data=periodL, aes(y = periodL$fly, x = periodL$time, colour = periodL$period)) +
       geom_line(aes_string(group = periodL$period)) + 
       scale_color_gradientn(colours=rainbow(4)) +
       geom_smooth() + 
       labs(x="time (ms)", y="fly") + 
       ggtitle(paste(flyname, "pooled traces for left periods"))
    flytraces[[2]] <- ggplot(data=flytracesL_data_frame, aes_string(x=flytracesL_data_frame$time, y=flytracesL_data_frame$fly)) +
      geom_line() +
      ggtitle("Pooled traces\n(left turning arena)") +
      labs(x="time(ms)", y="fly")

    flytraces[[3]] <- ggplot(data=periodR, aes(y = periodR$fly, x = periodR$time, colour = periodR$period)) +
       geom_line(aes_string(group = periodR$period)) + 
       scale_color_gradientn(colours=rainbow(4)) +
       geom_smooth() + 
       labs(x="time (ms)", y="fly") + 
       ggtitle(paste(flyname, "pooled traces for right periods"))
    flytraces[[4]] <- ggplot(data=flytracesR_data_frame, aes_string(x=flytracesR_data_frame$time, y=flytracesR_data_frame$fly)) +
      geom_line() +
      ggtitle("Pooled traces\n(right turning arena)") +
      labs(x="time(ms)", y="fly")
    
        
    #torque
    trqhistos[[NofPeriods+1]] <- ggplot(data=rawdata, aes_string(rawdata$torque)) + 
      geom_histogram(binwidth=3) + 
      labs(x="torque [arb units]", y="frequency") + 
      xlim(-600,600) +
      ggtitle(paste(flyname, "total"))
    
    #position 
    poshistos[[NofPeriods+1]] <- ggplot(data=rawdata, aes_string(rawdata$a_pos)) + 
      geom_histogram(binwidth=10) +
      labs(x="position [arb units]", y="frequency") + 
      xlim(-2047,2048) +
      ggtitle(paste(flyname, "total"))
    
    ##write histograms
    #torque
    if (sequence$type[1]=="fs" | sequence$type[1]=="color" | sequence$type[1]=="optomotor") {
      #torque
      multiplot(plotlist = trqhistos, cols=2)
    } else if (sequence$type[1]=="OptomotoL" | sequence$type[1]=="OptomotoR") {
      multiplot(plotlist = flyhistosR, cols = 4)
      multiplot(plotlist = flyhistosL, cols = 4)
      multiplot(plotlist = flytraces, cols = 2)
    }
```

```{r typePrep, echo=FALSE}
type <- isFALSE(sequence$type[1] == "OptomotoL" | sequence$type[1] == "OptomotoR") ###determine if platform or torque data
```

### 6. Position Histograms
    
```{r PositionHistogram, eval=type, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8}
    multiplot(plotlist = poshistos, cols=2)
```

### 7. Power spectrum and spectrogram:

```{r spectra, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8}
    if (sequence$type[1]=="fs"||sequence$type[1]=="color"||sequence$type[1]=="optomotor") {
      meanspec(rawdata$torque, f = samplerate, wl = 600) #plot mean power spectrum for each fly
      title(paste("Torque-Powerspectrum", flyname))
      spectro(rawdata$torque, f = samplerate, wl=600) #plot spectrogram for each fly
      title(paste("Torque-Spectrogram", flyname))
      speclist[[l]] = as.data.frame(meanspec(rawdata$torque, f = samplerate, wl = 600, plot = FALSE)) #collect each spectrum for later averaging
    } else if (sequence$type[1]=="OptomotoL"||sequence$type[1]=="OptomotoR") {
      meanspec(rawdata$fly, f = samplerate, wl = 600) #plot mean power spectrum for each fly
      title(paste("Fly-Powerspectrum", flyname))
      spectro(rawdata$fly, f = samplerate, wl=600, osc = TRUE) #plot spectrogram for each fly
      title(paste("Fly-Spectrogram", flyname))
      speclist[[l]] = as.data.frame(meanspec(rawdata$fly, f = samplerate, wl = 600, plot = FALSE)) #collect each spectrum for later averaging
    }
```

### 8. Learning and avoidance scores:

```{r PIs, eval=type, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8}
      barplot(sequence$lambda, main = paste("Performance Indices", flyname),
            xlab="Time [periods]",
            ylab="PI [rel. units]",
            space=0,
            col = sequence$color)
```

