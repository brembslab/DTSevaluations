---
title: "Single Fly Descriptive Data Evaluation Sheet"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float: true
---
<style type="text/css">
  body .main-container {
    max-width: 1800px !important;
  }
  h1.title {
  font-size: 38px;
  color: DarkRed;
  text-align: center;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, packages, eval=FALSE, echo=FALSE}
# load packages 
library(ggplot2)
library(tidyr)
library(dygraphs)
library(grid)
library(reshape2)
library(dplyr)
library(gridExtra)
library(yaml)
library(ggsignif)
library(effsize)
library(pwr)
library(BayesFactor)
library(genefilter)  # if not available for newest version: setRepositories(addURLs = c(CRANxtras = "http://www.stats.ox.ac.uk/pub/RWin"))
library(seewave)

## source the script with the functions needed for analysis
source("readXMLdatafile.R")
source("DTS_plotfunctions.R")
```

<center><h2>for time series experiment `r paste(flyname)`</h2></center>
<center>Rendered on `r format(Sys.time(), '%d %B %Y')`</center>

# Metadata

**Date and time of the experiment:** `r paste(experiment$dateTime)`  
**Raw data file (XML):** `r paste('<a href="../', basename(xml_name), '">', flyname, '</a>', sep = "")`  
**Experimenter:** `r paste(experimenter$firstname, experimenter$lastname, sep = " ")`; **ORCID:** [`r paste(experimenter$orcid)`](http://orcid.org/`r paste(experimenter$orcid)`)  
**Experiment description:** `r paste(experiment$description)`  
**Experiment duration:** `r paste(experiment$duration)`s  
**Arena type:** `r paste(experiment$arena_type)`; **Measurement device:** `r paste(experiment$meter_type)`  
**Fly description:** `r paste(fly$description)`; **FlyBase ID:** [`r paste(fly$flybase)`](http://flybase.org/reports/`r paste(fly$flybase)`)  
**Sampling rate:** `r paste(experiment$sample_rate)`Hz
```{r sr_condition, echo=FALSE}
sampleratecondition <- round(real_sample_rate)>20
```

```{r samplerate, eval=sampleratecondition, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, comment=NA, results = 'asis'}
cat("<b>Actual samplingrate: </b>", paste(round(real_sample_rate,4)), " Hz; <b>Downsampled sampling rate (target 20 Hz):</b> ", paste(round(down_sample_rate,4)), " Hz")
```

# Experimental Design
```{r expdesign, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 3, fig.width = (NofPeriods+1)}
    #plot table of period sequence
    periods=t(sequence)
    colnames(periods)<-sprintf("Period %s",1:NofPeriods)
    grid.table(periods)
```

# Time Traces
## Interactive Time Traces

```{r dytraces, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 4, fig.width = 12}    
    
    ##dyplot traces
    dytraces(rawdata)

```

## Time Traces by Period

```{r PeriodTraces, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 10}

#add columns for PIs to sequence data
    sequence$lambda <- NA

    for(i in 1:NofPeriods){
      
      #save colors for later plotting
      if(sequence$outcome[i]==0){
        sequence$color[i]="lightyellow"
        sequence$histocolor[i]="darkgreen"
      } else {
        sequence$color[i]="orange"
        sequence$histocolor[i]="orange"
        }
     if(sequence$contingency[i]==""){
        sequence$color[i]=NA
        sequence$histocolor[i]="red"
        }
      
      ##only look at period data
      temp  <- rawdata[rawdata$period == i, ]
      keeps = c("a_pos","fly")
      period.data[[i]] <- temp[keeps] #list only arena position and fly behavior data by period
      
      if(sequence$type[i]=="fs"||sequence$type[i]=="color"||sequence$type[i]=="optomotorR"||sequence$type[i]=="optomotorL")
      {
        ## plot the fly behavior and arena position time traces
        fly_pos_traces(temp)
      }

      ##Calculate period histograms
      #fly behavior
      flyhistos[[i]] <- ggplot(data=temp, aes_string(temp$fly)) +
        geom_histogram(binwidth = 3, fill = sequence$histocolor[i]) +
        labs(x="Torque [arb units]", y="frequency") +
        xlim(maxfly) +
        ggtitle(paste(flyname, "Period", i))
      
      #arena position
      if(sequence$type[i]=="fs"||sequence$type[i]=="color")
      {
        poshistos[[i]] <- ggplot(data=temp, aes_string(temp$a_pos)) +
          geom_histogram(binwidth=10, fill = sequence$histocolor[i]) +
          labs(x="Arena Position [degrees*10]", y="frequency") +
          xlim(-1800,1800) +
          ggtitle(paste(flyname, "Period", i))
      }
      
      
      ##calculate PIs
      ##create data.frame for adding PIs if it doesn't eist, yet
      if(!exists("PIprofile")){PIprofile <- data.frame(matrix(ncol = NofPeriods))}
      
      if(sequence$type[i]=="fs"||sequence$type[i]=="color") #for arena position
      {
        t1 = sum(abs(temp$a_pos) >= 450 & abs(temp$a_pos) <= 1350)
        t2 = nrow(temp)-t1
        sequence$lambda[i] = (t1-t2)/(t1+t2)
        if (sequence$contingency[i] == '2_4_Q'){sequence$lambda[i]=-sequence$lambda[i]}
        if(l==1){PIprofile[1,i]=sequence$lambda[i]}
      } else if (sequence$type[i]=="yt" || sequence$type[i]=="sw_blue" || sequence$type[i]=="sw_green") #calculate torque PIs
      {
        table1 <- table(sign(temp$fly)) 
        t1 = table1[2]
        t2 = nrow(temp)-t1
        sequence$lambda[i] = (t1-t2)/(t1+t2)
        if (sequence$contingency[i] == 'right_torque'){sequence$lambda[i]=-sequence$lambda[i]}
        if(l==1){PIprofile[1,i]=sequence$lambda[i]}
      }
    } #for Number of Periods
    
```

# Histograms
## Fly Behavior Histograms

```{r FlyHistogram, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8}    
    
    ## plot position and fly histograms ##
    #fly behavior
    flyhistos[[NofPeriods+1]] <- ggplot(data=rawdata, aes_string(rawdata$fly)) + 
      geom_histogram(binwidth=3) + 
      labs(x="torque [arb units]", y="frequency") + 
      xlim(-maxfly) +
      ggtitle(paste(flyname, "total"))
    
    #position
    poshistos[[NofPeriods+1]] <- ggplot(data=rawdata, aes_string(rawdata$a_pos)) + 
      geom_histogram(binwidth=10) +
      labs(x="position [degrees*10]", y="frequency") + 
      xlim(-1800,1800) +
      ggtitle(paste(flyname, "total"))
    
    ##write histograms
    #fly behavior
    multiplot(plotlist = flyhistos, cols=round(NofPeriods/5))
```

## Arena Position Histograms
    
```{r PositionHistogram, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8}    
    multiplot(plotlist = Filter(Negate(is.null), poshistos), cols=round(sum(poshistos!="NULL")/5))
```

<!-- Evaluate optomotor data if they are present -->

```{r om, echo=FALSE}
om <- any(grepl("optomotor", sequence$type)==TRUE) ###determine if there are optomotor periods
```

`r if (om) '# Optomotor evaluations'`
`r if (om) '## Optomotor traces (right/left)'`

```{r OptomotorTraces, eval=om, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

### extract optomotor traces and generate dataframe for right (clockwise) turning arena
rightOMperiods=which(grepl("optomotorR", sequence$type)) #collect the right turning OM periods
rightOMdata<-filter(rawdata, rawdata$period %in% rightOMperiods) #extract only right turning arena periods
rightOMdata <- rightOMdata %>% select(-c(a_pos,date)) #drop unnecessary columns
rightOMdata$time=ave(rightOMdata$period, rightOMdata$period, FUN=seq_along) #match the time values to start at each period start
rightOMdata$time=(rightOMdata$time-1)*50 #make 20Hz data into ms time scale
rightOMdata$period=as.factor(rightOMdata$period)
ggplot(data = rightOMdata, aes(x=time/1000, y=fly)) + 
  geom_hline(yintercept = 0) +
  geom_line(aes(group=period, colour=period), size=1) + 
  geom_smooth(method="loess", span = 0.1) +
  ylab("Optomotor Resoponse [rel. units]")+ 
  xlab("Time [s]") + 
  ggtitle(paste("Right (clockwise) arena rotations -", flyname)) +
  theme_classic()+
  scale_x_discrete(expand = expand_scale(add = 0))

### extract optomotor traces and generate dataframe for left turning (counter-clockwise) arena
leftOMperiods=which(grepl("optomotorL", sequence$type)) #collect the left turning OM periods
leftOMdata<-filter(rawdata, rawdata$period %in% leftOMperiods)  #extract only left turning arena periods
leftOMdata <- leftOMdata %>% select(-c(a_pos,date))  #drop unnecessary columns
leftOMdata$time=ave(leftOMdata$period, leftOMdata$period, FUN=seq_along) #match the time values to start at each period start
leftOMdata$time=((leftOMdata$time)*50)+max(rightOMdata$time) #make 20Hz data into ms time scale, starting after right turning data
leftOMdata$period=as.factor(leftOMdata$period)
ggplot(data = leftOMdata, aes(x=time/1000, y=fly)) + 
  geom_hline(yintercept = 0) +
  geom_line(aes(group=period, colour=period), size=1) + 
  geom_smooth(method="loess", span = 0.1) +
  ylab("Optomotor Resoponse [rel. units]")+ 
  xlab("Time [s]") +
  ggtitle(paste("Left (counter-clockwise) arena rotations -", flyname)) +
  theme_classic() +
  scale_x_discrete(expand = expand_scale(add = 0))

### generate averaged optomotor responses ovr both rotation directions
tempOMdata=rbind(rightOMdata,leftOMdata) #combine left and right OMdata in one dataframe
tempOMdata=aggregate(tempOMdata$fly,FUN=mean,by=list(tempOMdata$time)) #average across periods
colnames(tempOMdata) <- c("time", as.character(flyname)) #set dataframe names

if(!exists("OMdata"))
{
  OMdata=tempOMdata
} else {
  OMdata[[as.character(flyname)]]=tempOMdata[[as.character(flyname)]]
}
```

`r if (om) '## Averaged optomotor response'`

```{r OptomotorAverage, eval=om, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

ggplot(data=OMdata, aes(x=OMdata$time/1000, y=OMdata[[as.character(flyname)]])) + 
  geom_rect(aes(xmin = 30,xmax = 60,ymin = -Inf, ymax = Inf),fill=("grey"), alpha = 0.01)+
  geom_hline(yintercept = 0) +
  geom_line() +
  ylab("Optomotor Resoponse [rel. units]")+ 
  xlab("Time [s]") +
  theme_classic() + 
  annotate("text", -Inf, Inf, label = "Right (clockwise) arena rotations", hjust = -0.1, vjust = 1.3)+
  annotate("text", Inf, -Inf, label = "Left (clockwise) arena rotations", hjust =1.1, vjust = -1.5)+ 
  theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line( size=.1, color="black"))+
  scale_x_discrete(expand = expand_scale(add = 0))
  

```

`r if (om) '## Further optomotor evaluations'`

```{r moreOptomotor, eval=om, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 12, fig.width = 8, comment=NA, results='asis'}    

###generate traces to fit nonlinear model
# Find the midpoint in left and right turning in averaged traces (OMdata)
OMmidpoint = OMdata$time[nrow(OMdata)]/2

#right turning traces
x1=OMdata$time[OMdata$time<=OMmidpoint]                                   #time
rOMlow=abs(min(OMdata[[as.character(flyname)]][OMdata$time<=OMmidpoint])) #find lowest value in the right turning trace
y=OMdata[[as.character(flyname)]][OMdata$time<=OMmidpoint]+rOMlow         #mean right OM response normalized to positive values
m<-nls(y~a*x1/(b+x1))                                                     #use Michaelis-Menten to fit the data
right=coef(m)                                                             #put the right turning coefficients in a vector

#left turning traces
x1=OMdata$time[OMdata$time>OMmidpoint]                                    #time
x1=x1-x1[1]                                                               #set time to start from zero
lOMlow=abs(min(OMdata[[as.character(flyname)]][OMdata$time>OMmidpoint]))  #find lowest value in the left turning trace
y=-OMdata[[as.character(flyname)]][OMdata$time>OMmidpoint]+lOMlow         #mean left OM response normalized to positive values
m<-nls(y~a*x1/(b+x1))                                                     #use Michaelis-Menten to fit the data
left=coef(m)                                                              #put the left turning coefficients in a vector

###calculate averages and asymmetries to three significant digits
  #bring left and right asymptotes back to actual values
right[1]=right[1]-rOMlow
left[1]=left[1]-lOMlow
aveOMcoeff=signif((right+left)/2, 3)       #mean asymptote and halfmaximal time
aveOMcoeff[2]=signif(aveOMcoeff[2]/1000, 3)                  #halfmaximal time in seconds
OMasym=signif((right-left)/(right+left), 3)                  #asymmetry index

###collect coefficients for plotting and export
tempOMparams <- as.data.frame(rbind(as.numeric(aveOMcoeff))) #gather asymptote and halfmaximal time
tempOMparams$v3 = OMasym[1]                                  #add asymptote asymmetry index
names(tempOMparams) = c("asymptote", "halfmax_time","AI")    #set column names
rownames(tempOMparams)[1]=as.character(flyname)              #set row names to flynames
kable(tempOMparams)                                          #plot table with data

###collect all coefficients in dataframe for the group
if(!exists("OMparams"))
{
  OMparams=tempOMparams
} else {
  OMparams[as.character(flyname),]=tempOMparams
}

```

# Power spectrum and spectrogram

```{r spectra, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8}
    meanspec(rawdata$fly, f = down_sample_rate, wl = 600) #plot mean power spectrum for each fly
    title(paste("Torque-Powerspectrum", flyname))
    spectro(rawdata$fly, f = down_sample_rate, wl=600) #plot spectrogram for each fly
    title(paste("Torque-Spectrogram", flyname))
    speclist[[l]] = as.data.frame(meanspec(rawdata$fly, f = down_sample_rate, wl = 600, plot = FALSE)) #collect each spectrum for later averaging
```

# Learning and avoidance scores

```{r PIs, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.align = "center", fig.height = 6, fig.width = 8}
    barplot(as.vector(na.omit(sequence$lambda)), main = paste("Performance Indices", flyname),
            xlab="Time [periods]",
            ylab="PI [rel. units]",
            space=0,
            col = as.vector(na.omit(sequence$color)))
```

